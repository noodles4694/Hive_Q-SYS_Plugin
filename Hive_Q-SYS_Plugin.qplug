-- Information block for the plugin
PluginInfo = {
  Name = "Hive~Beeblade",
  Version = "1.0",
  BuildVersion = "0.0.0.575",
  Id = "c88de492-bccb-49bb-9927-852367b9eb16",
  Author = "Carrier Labs & Hive Media Control",
  Description = "Plugin to control Hive Beeblade, Beebox and Nexus devices" ,
  ShowDebug = true 
}
-- This file contains constant variables used throughout the project
-- These variables should not be changed during runtime
local layer_count = 2
local max_media_items = 255

--create a table of colors to be used in the UI
local Colors = {
  hive_yellow = {255, 215, 0},
  hive_grey = {18, 22, 26},
  White = {255, 255, 255},
  Black = {0, 0, 0},
  Red = {255, 0, 0},
  Green = {0, 255, 0},
  enable_green = {0, 164, 0},
  transparent = {0, 0, 0, 0},
  control_label = {170, 170, 170},
  control_background = {18, 22, 26},
  control_background_light = {64, 64, 64},
  control_text = {170, 170, 170},
}

-- Define a list of controls with their properties
local control_list = {
  ["File Select"] = {
    Name = "file_select_",
    ControlType = "Text",
    Style = "ComboBox",
    PinStyle = "Both",
    UserPin = true
  },
  ["File Select Index"] = {
    Name = "file_select_index_",
    ControlType = "Knob",
    ControlUnit = "Integer",
    Style = "None",
    Min = 0,
    Max = 65535,
    PinStyle = "Both",
    UserPin = true
  },
  ["Folder Select"] = {
    Name = "folder_select_",
    ControlType = "Text",
    Style = "ComboBox",
    PinStyle = "Both",
    UserPin = true
  },
  ["Folder Select Index"] = {
    Name = "folder_select_index_",
    ControlType = "Knob",
    ControlUnit = "Integer",
    Style = "None",
    Min = 0,
    Max = 65535,
    PinStyle = "Both",
    UserPin = true
  },
  ["Time Elapsed"] = {
    Name = "time_elapsed_",
    ControlType = "Indicator",
    IndicatorType = "Text",
    PinStyle = "Output",
    UserPin = true
  },
  ["Duration"] = {
    Name = "duration_",
    ControlType = "Indicator",
    IndicatorType = "Text",
    PinStyle = "Output",
    UserPin = true
  },
  ["Seek"] = {
    Name = "seek_",
    ControlType = "Knob",
    ControlUnit = "Percent",
    Style = "Fader",
    Min = 0,
    Max = 100,
    PinStyle = "Both",
    UserPin = true
  },
  ["Intensity"] = {
    Name = "intensity_",
    ControlType = "Knob",
    ControlUnit = "Percent",
    Style = "Text Field",
    Min = 0,
    Max = 100,
    PinStyle = "Both",
    UserPin = true
  },
  ["In Frame"] = {
    Name = "in_frame_",
    ControlType = "Knob",
    ControlUnit = "Integer",
    Style = "Text Field",
    Min = 0,
    Max = 9999999,
    PinStyle = "Both",
    UserPin = true
  },
  ["Out Frame"] = {
    Name = "out_frame_",
    ControlType = "Knob",
    ControlUnit = "Integer",
    Style = "Text Field",
    Min = 0,
    Max = 9999999,
    PinStyle = "Both",
    UserPin = true
  },
  ["Play Mode"] = {
    Name = "play_mode_",
    ControlType = "Text",
    Style = "ComboBox",
    PinStyle = "Both",
    UserPin = true
  },
  ["Play Mode Index"] = {
    Name = "play_mode_index_",
    ControlType = "Knob",
    ControlUnit = "Integer",
    Style = "None",
    Min = 0,
    Max = 65535,
    PinStyle = "Both",
    UserPin = true
  },
  ["Framing Mode"] = {
    Name = "framing_mode_",
    ControlType = "Text",
    Style = "ComboBox",
    PinStyle = "Both",
    UserPin = true
  },
  ["Framing Mode Index"] = {
    Name = "framing_mode_index_",
    ControlType = "Knob",
    ControlUnit = "Integer",
    Style = "None",
    Min = 0,
    Max = 65535,
    PinStyle = "Both",
    UserPin = true
  },
  ["Blend Mode"] = {
    Name = "blend_mode_",
    ControlType = "Text",
    Style = "ComboBox",
    PinStyle = "Both",
    UserPin = true
  },
  ["Blend Mode Index"] = {
    Name = "blend_mode_index_",
    ControlType = "Knob",
    ControlUnit = "Integer",
    Style = "None",
    Min = 0,
    Max = 65535,
    PinStyle = "Both",
    UserPin = true
  },
  ["LUT"] = {
    Name = "lut_",
    ControlType = "Text",
    Style = "ComboBox",
    PinStyle = "Both",
    UserPin = true
  },
  ["LUT Index"] = {
    Name = "lut_index_",
    ControlType = "Knob",
    ControlUnit = "Integer",
    Style = "None",
    Min = 0,
    Max = 65535,
    PinStyle = "Both",
    UserPin = true
  },
  ["Play Speed"] = {
    Name = "play_speed_",
    ControlType = "Knob",
    ControlUnit = "Percent",
    Style = "Text Field",
    Min = 0,
    Max = 1000,
    PinStyle = "Both",
    UserPin = true
  },
  ["Move Speed"] = {
    Name = "move_speed_",
    ControlType = "Knob",
    ControlUnit = "Percent",
    Min = 0,
    Max = 100,
    PinStyle = "Both",
    UserPin = true
  },
  ["MTC Hour"] = {
    Name = "mtc_hour_",
    ControlType = "Knob",
    ControlUnit = "Integer",
    Style = "Text Field",
    Min = 0,
    Max = 23,
    PinStyle = "Both",
    UserPin = true
  },
  ["MTC Minute"] = {
    Name = "mtc_minute_",
    ControlType = "Knob",
    ControlUnit = "Integer",
    Style = "Text Field",
    Min = 0,
    Max = 59,
    PinStyle = "Both",
    UserPin = true
  },
  ["MTC Second"] = {
    Name = "mtc_second_",
    ControlType = "Knob",
    ControlUnit = "Integer",
    Style = "Text Field",
    Min = 0,
    Max = 59,
    PinStyle = "Both",
    UserPin = true
  },
  ["MTC Frame"] = {
    Name = "mtc_frame_",
    ControlType = "Knob",
    ControlUnit = "Integer",
    Style = "Text Field",
    Min = 0,
    Max = 59,
    PinStyle = "Both",
    UserPin = true
  },
  ["Scale"] = {
    Name = "scale_",
    ControlType = "Knob",
    ControlUnit = "Percent",
    Style = "Text Field",
    Min = 0,
    Max = 1000,
    PinStyle = "Both",
    UserPin = true
  },
  ["Aspect Ratio"] = {
    Name = "aspect_ratio_",
    ControlType = "Knob",
    ControlUnit = "Percent",
    Style = "Text Field",
    Min = 0,
    Max = 100,
    PinStyle = "Both",
    UserPin = true
  },
  ["Position X"] = {
    Name = "position_x_",
    ControlType = "Knob",
    ControlUnit = "Percent",
    Style = "Text Field",
    Min = -100,
    Max = 100,
    PinStyle = "Both",
    UserPin = true
  },
  ["Position Y"] = {
    Name = "position_y_",
    ControlType = "Knob",
    ControlUnit = "Percent",
    Style = "Text Field",
    Min = -100,
    Max = 100,
    PinStyle = "Both",
    UserPin = true
  },
  ["Rotation X"] = {
    Name = "rotation_x_",
    ControlType = "Knob",
    ControlUnit = "Percent",
    Style = "Text Field",
    Min = -1440,
    Max = 1440,
    PinStyle = "Both",
    UserPin = true
  },
  ["Rotation Y"] = {
    Name = "rotation_y_",
    ControlType = "Knob",
    ControlUnit = "Percent",
    Style = "Text Field",
    Min = -1440,
    Max = 1440,
    PinStyle = "Both",
    UserPin = true
  },
  ["Rotation Z"] = {
    Name = "rotation_z_",
    ControlType = "Knob",
    ControlUnit = "Percent",
    Style = "Text Field",
    Min = -1440,
    Max = 1440,
    PinStyle = "Both",
    UserPin = true
  },
  ["Red"] = {
    Name = "red_",
    ControlType = "Knob",
    ControlUnit = "Percent",
    Style = "Text Field",
    Min = -100,
    Max = 100,
    PinStyle = "Both",
    UserPin = true
  },
  ["Green"] = {
    Name = "green_",
    ControlType = "Knob",
    ControlUnit = "Percent",
    Style = "Text Field",
    Min = -100,
    Max = 100,
    PinStyle = "Both",
    UserPin = true
  },
  ["Blue"] = {
    Name = "blue_",
    ControlType = "Knob",
    ControlUnit = "Percent",
    Style = "Text Field",
    Min = -100,
    Max = 100,
    PinStyle = "Both",
    UserPin = true
  },
  ["Hue"] = {
    Name = "hue_",
    ControlType = "Knob",
    ControlUnit = "Percent",
    Style = "Text Field",
    Min = 0,
    Max = 100,
    PinStyle = "Both",
    UserPin = true
  },
  ["Saturation"] = {
    Name = "saturation_",
    ControlType = "Knob",
    ControlUnit = "Percent",
    Style = "Text Field",
    Min = -100,
    Max = 100,
    PinStyle = "Both",
    UserPin = true
  },
  ["Contrast"] = {
    Name = "contrast_",
    ControlType = "Knob",
    ControlUnit = "Percent",
    Style = "Text Field",
    Min = -100,
    Max = 100,
    PinStyle = "Both",
    UserPin = true
  },
  ["Strobe"] = {
    Name = "strobe_",
    ControlType = "Knob",
    ControlUnit = "Percent",
    Style = "Text Field",
    Min = 0,
    Max = 100,
    PinStyle = "Both",
    UserPin = true
  },
  ["Volume"] = {
    Name = "volume_",
    ControlType = "Knob",
    ControlUnit = "Percent",
    Style = "Text Field",
    Min = 0,
    Max = 100,
    PinStyle = "Both",
    UserPin = true
  },
  ["Transition Duration"] = {
    Name = "transition_duration_",
    ControlType = "Knob",
    ControlUnit = "Integer",
    Style = "Text Field",
    Min = 0,
    Max = 65535,
    PinStyle = "Both",
    UserPin = true
  },
  ["Transition Mode"] = {
    Name = "transition_mode_",
    ControlType = "Text",
    Style = "ComboBox",
    PinStyle = "Both",
    UserPin = true
  },
  ["Transition Mode Index"] = {
    Name = "transition_mode_index_",
    ControlType = "Knob",
    ControlUnit = "Integer",
    Style = "None",
    Min = 0,
    Max = 65535,
    PinStyle = "Both",
    UserPin = true
  },
}
-- Create a list of parameter names for easy reference
local parameter_list = {
  "Folder Select",
  "File Select",
  "Time Elapsed",
  "Duration",
  "Seek",
  "Intensity",
  "In Frame",
  "Out Frame",
  "Play Mode",
  "Framing Mode",
  "Blend Mode",
  "LUT",
  "Play Speed",
  "Move Speed",
  "MTC Hour",
  "MTC Minute",
  "MTC Second",
  "MTC Frame",
  "Scale",
  "Aspect Ratio",
  "Position X",
  "Position Y",
  "Rotation X",
  "Rotation Y",
  "Rotation Z",
  "Red",
  "Green",
  "Blue",
  "Hue",
  "Saturation",
  "Contrast",
  "Strobe",
  "Volume",
  "Transition Duration",
  "Transition Mode"
}

local pinonly_list = {
"File Select Index",
"Folder Select Index",
"Play Mode Index",
"Framing Mode Index",
"Blend Mode Index",
"LUT Index",
"Transition Mode Index",
"FX1 Select Index",
"FX2 Select Index"
}

local fx1_list = {}
local fx2_list = {}
-- Add FX1 and FX2 parameters to fx1_list, fx2_list
control_list["FX1 Select"] = {
  Name = "fx1_select_",
  ControlType = "Text",
  Style = "ComboBox",
  PinStyle = "Both",
  UserPin = true
}
control_list["FX1 Select Index"] = {
  Name = "fx1_select_index_",
  ControlType = "Knob",
  ControlUnit = "Integer",
  Style = "None",
  Min = 0,
  Max = 65535,
  PinStyle = "Both",
  UserPin = true
}
fx1_list[#fx1_list + 1] = "FX1 Select"
control_list["FX1 Opacity"] = {
  Name = "fx1_opacity_",
  ControlType = "Knob",
  ControlUnit = "Percent",
  Style = "Text Field",
  Min = 0,
  Max = 100,
  PinStyle = "Both",
  UserPin = true
}
fx1_list[#fx1_list + 1] = "FX1 Opacity"
for i = 1, 16 do
  control_list["FX1 Param " .. i] = {
    Name = "fx1_param_" .. i .. "_",
    ControlType = "Knob",
    ControlUnit = "Percent",
    Style = "Text Field",
    Min = 0,
    Max = 100,
    PinStyle = "Both",
    UserPin = true
  }
  fx1_list[#fx1_list + 1] = "FX1 Param " .. i
end
control_list["FX2 Select"] = {
  Name = "fx2_select_",
  ControlType = "Text",
  Style = "ComboBox",
  PinStyle = "Both",
  UserPin = true
}
fx2_list[#fx2_list + 1] = "FX2 Select"
control_list["FX2 Opacity"] = {
  Name = "fx2_opacity_",
  ControlType = "Knob",
  ControlUnit = "Percent",
  Style = "Text Field",
  Min = 0,
  Max = 100,
  PinStyle = "Both",
  UserPin = true
}
control_list["FX2 Select Index"] = {
  Name = "fx2_select_index_",
  ControlType = "Knob",
  ControlUnit = "Integer",
  Style = "None",
  Min = 0,
  Max = 65535,
  PinStyle = "Both",
  UserPin = true
}
fx2_list[#fx2_list + 1] = "FX2 Opacity"

for i = 1, 16 do
  control_list["FX2 Param " .. i] = {
    Name = "fx2_param_" .. i .. "_",
    ControlType = "Knob",
    ControlUnit = "Percent",
    Style = "Text Field",
    Min = 0,
    Max = 100,
    PinStyle = "Both",
    UserPin = true
  }
  fx2_list[#fx2_list + 1] = "FX2 Param " .. i
end
-- Define the color of the plugin object in the design
function GetColor(props)
  return Colors.hive_yellow
end

-- The name that will initially display when dragged into a design
function GetPrettyName(props)
  if
    props["Model"] == nil or props["Model"].Value == "PLUTO" or props["Model"].Value == "OSMIA" or
      props["Model"].Value == "MINIMA" or
      props["Model"].Value == "NEXUS"
   then
    return "Hive Beeblade" .. string.char(10) .. props["Model"].Value .. string.char(10) .. props["IP Address"].Value
  else
    return "Hive" .. string.char(10) .. props["Model"].Value .. string.char(10) .. props["IP Address"].Value
  end
end

-- Optional function used if plugin has multiple pages
PageNames = {}
function CreatePages()
  PageNames = {"Status"}
  for i = 1, layer_count do
    table.insert(PageNames, "Layer " .. i)
  end
  table.insert(PageNames, "Media")
  table.insert(PageNames, "Modules")
  table.insert(PageNames, "Preview")
end

function GetPages(props)
  local pages = {}
  CreatePages()
  for ix, name in ipairs(PageNames) do
    table.insert(pages, {name = PageNames[ix]})
  end
  return pages
end

-- Optional function to define model if plugin supports more than one model
function GetModel(props)
  local model = {}
  if props.Model ~= nil and props.Model.Value ~= "" then
    table.insert(model, { props.Model.Value } )
  else
    table.insert(model, { "Pluto" } )
  end
  return model
end

-- Define User configurable Properties of the plugin
function GetProperties()
  local props = {}
  table.insert(
    props,
    {
      Name = "IP Address",
      Type = "string",
      Value = "192.168.1.51"
    }
  )
  
  table.insert(
    props,
    {
      Name = "MAC Address",
      Type = "string",
      Value = "24:1C:04:1C:7D:AB"
    }
  )
  
  table.insert(
    props,
    {
      Name = "Model",
      Type = "enum",
      Choices = {"PLUTO", "OSMIA", "MINIMA", "NEXUS", "PLAYER_1", "PLAYER_2", "PLAYER_3", "PLAYER_4"},
      Value = "PLUTO"
    }
  )
  
  table.insert(
    props,
    {
      Name = "Media List Count",
      Type = "integer",
      Value = 20,
      Min = 1,
      Max = 255
    }
  )
  
  table.insert(
    props,
    {
      Name = "Output Video Preview",
      Type = "enum",
      Choices = {"Disabled", "Enabled"},
      Value = "Disabled"
    }
  )
  
  table.insert(
    props,
    {
      Name = "Preview Refresh",
      Type = "enum",
      Choices = {"0.1 fps", "0.5 fps", "1 fps", "2 fps", "5 fps", "10 fps", "15 fps"},
      Value = "1 fps"
    }
  )
  
  table.insert(
    props,
    {
      Name = "Enable JSON Data Pins (WARNING)",
      Type = "enum",
      Choices = {"Disabled", "Enabled"},
      Value = "Disabled"
    }
  )
  
  table.insert(
    props,
    {
      Name = "Logging Level",
      Type = "enum",
      Choices = {"Normal", "Errors Only", "Debug"},
      Value = "Normal"
    }
  )
  return props
end

-- Optional function to define pins on the plugin that are not connected to a Control
function GetPins(props)
  local pins = {}
  -- No Pins!
  return pins
end

-- Optional function to update available properties when properties are altered by the user
function RectifyProperties(props)
  
  return props
end

-- Optional function to define components used within the plugin
function GetComponents(props)
  local components = {}
  -- No components!
  return components
end

-- Optional function to define wiring of components used within the plugin
function GetWiring(props)
  local wiring = {}
  -- No Wiring!
  return wiring
end

-- Defines the Controls used within the plugin
function GetControls(props)
  local ctrls = {}
  CreatePages()
  -- Controls for Status Page
  table.insert(
    ctrls,
    {
      Name = "IPAddress",
      ControlType = "Text",
      --IndicatorType = "Text",
      PinStyle = "Output",
      Count = 1,
      UserPin = true
    }
  )
  table.insert(
    ctrls,
    {
      Name = "DeviceName",
      ControlType = "Indicator",
      IndicatorType = "Text",
      PinStyle = "Output",
      Count = 1,
      UserPin = true
    }
  )
  table.insert(
    ctrls,
    {
      Name = "Version",
      ControlType = "Indicator",
      IndicatorType = "Text",
      PinStyle = "Output",
      Count = 1,
      UserPin = true
    }
  )
  table.insert(
    ctrls,
    {
      Name = "Status",
      ControlType = "Indicator",
      IndicatorType = "Status",
      PinStyle = "Output",
      Count = 1,
      UserPin = true
    }
  )
  table.insert(
    ctrls,
    {
      Name = "OutputResolution",
      ControlType = "Indicator",
      IndicatorType = "Text",
      PinStyle = "Output",
      Count = 1,
      UserPin = true
    }
  )
  table.insert(
    ctrls,
    {
      Name = "OutputFramerate",
      ControlType = "Indicator",
      IndicatorType = "Text",
      PinStyle = "Output",
      Count = 1,
      UserPin = true
    }
  )
  table.insert(
    ctrls,
    {
      Name = "EngineFPS",
      ControlType = "Indicator",
      IndicatorType = "Text",
      PinStyle = "Output",
      Count = 1,
      UserPin = true
    }
  )
  table.insert(
    ctrls,
    {
      Name = "Activity",
      ControlType = "Indicator",
      IndicatorType = "Text",
      PinStyle = "Output",
      Count = 1,
      UserPin = true
    }
  )
  table.insert(
    ctrls,
    {
      Name = "Netmask",
      ControlType = "Indicator",
      IndicatorType = "Text",
      PinStyle = "Output",
      Count = 1,
      UserPin = true
    }
  )
  table.insert(
    ctrls,
    {
      Name = "SerialNumber",
      ControlType = "Indicator",
      IndicatorType = "Text",
      PinStyle = "Output",
      Count = 1,
      UserPin = true
    }
  )
  table.insert(
    ctrls,
    {
      Name = "BeeType",
      ControlType = "Indicator",
      IndicatorType = "Text",
      PinStyle = "Output",
      Count = 1,
      UserPin = true
    }
  )
  table.insert(
    ctrls,
    {
      Name = "FileCount",
      ControlType = "Indicator",
      IndicatorType = "Text",
      PinStyle = "Output",
      Count = 1,
      UserPin = true
    }
  )
  table.insert(
    ctrls,
    {
      Name = "Universe",
      ControlType = "Indicator",
      IndicatorType = "Text",
      PinStyle = "Output",
      Count = 1,
      UserPin = true
    }
  )
  table.insert(
    ctrls,
    {
      Name = "FreeSpace",
      ControlType = "Indicator",
      IndicatorType = "Text",
      PinStyle = "Output",
      Count = 1,
      UserPin = true
    }
  )
  table.insert(
    ctrls,
    {
      Name = "CpuPower",
      ControlType = "Indicator",
      IndicatorType = "Text",
      PinStyle = "Output",
      Count = 1,
      UserPin = true
    }
  )
  table.insert(
    ctrls,
    {
      Name = "SyncStatus",
      ControlType = "Indicator",
      IndicatorType = "Text",
      PinStyle = "Output",
      Count = 1,
      UserPin = true
    }
  )
  table.insert(
    ctrls,
    {
      Name = "Thumbnail",
      ControlType = "Button",
      ButtonType = "Momentary",
      PinStyle = "Output",
      Count = 1,
      UserPin = true
    }
  )
  
  -- Controls for Media, Preview and Layers Pages
  for i = 1, layer_count do
    for k, v in pairs(control_list) do
      table.insert(
        ctrls,
        {
          Name = v.Name .. i,
          ControlType = v.ControlType,
          ControlUnit = v.ControlUnit,
          Min = v.Min,
          Max = v.Max,
          PinStyle = v.PinStyle,
          UserPin = v.UserPin
        }
      )
    end
    for p = 1, max_media_items do
      table.insert(
        ctrls,
        {
          Name = string.format("MediaName%sLayer%s", p, i),
          ControlType = "Indicator",
          IndicatorType = "Text",
          PinStyle = "Output",
          UserPin = true
        }
      )
      table.insert(
        ctrls,
        {
          Name = string.format("MediaThumbnail%sLayer%s", p, i),
          ControlType = "Button",
          ButtonType = "StateTrigger",
          Min = 0,
          Max = 1,
          PinStyle = "None",
          UserPin = false
        }
      )
    end
    table.insert(
      ctrls,
      {
        Name = string.format("Layer%sPreview", i),
        ControlType = "Button",
        ButtonType = "Trigger",
        UserPin = false
      }
    )
  end
  
  table.insert(
    ctrls,
    {
      Name = "OutputPreview",
      ControlType = "Button",
      ButtonType = "Trigger",
      UserPin = false
    }
  )
  -- Controls for Modules Page
  table.insert(
    ctrls,
    {
      Name = "PlaylistEnable",
      ControlType = "Button",
      ButtonType = "Toggle",
      PinStyle = "Both",
      Count = 1,
      UserPin = true
    }
  )
  table.insert(
    ctrls,
    {
      Name = "L1TimecodeEnable",
      ControlType = "Button",
      ButtonType = "Toggle",
      PinStyle = "Both",
      Count = 1,
      UserPin = true
    }
  )
  table.insert(
    ctrls,
    {
      Name = "L2TimecodeEnable",
      ControlType = "Button",
      ButtonType = "Toggle",
      PinStyle = "Both",
      Count = 1,
      UserPin = true
    }
  )
  table.insert(
    ctrls,
    {
      Name = "TimelineEnable",
      ControlType = "Button",
      ButtonType = "Toggle",
      PinStyle = "Both",
      Count = 1,
      UserPin = true
    }
  )
  table.insert(
    ctrls,
    {
      Name = "ScheduleEnable",
      ControlType = "Button",
      ButtonType = "Toggle",
      PinStyle = "Both",
      Count = 1,
      UserPin = true
    }
  )
  table.insert(
    ctrls,
    {
      Name = "PlaylistRows",
      ControlType = "Knob",
      ControlUnit = "Integer",
      Style = "Text Field",
      PinStyle = "Output",
      Min = 0,
      Max = 9999999,
      Count = 1,
      UserPin = true
    }
  )
  table.insert(
    ctrls,
    {
      Name = "PlaylistCurrentRow",
      ControlType = "Knob",
      ControlUnit = "Integer",
      Style = "Text Field",
      PinStyle = "Output",
      Min = 0,
      Max = 9999999,
      Count = 1,
      UserPin = true
    }
  )
  table.insert(
    ctrls,
    {
      Name = "L1TCRows",
      ControlType = "Knob",
      ControlUnit = "Integer",
      Style = "Text Field",
      PinStyle = "Output",
      Min = 0,
      Max = 9999999,
      Count = 1,
      UserPin = true
    }
  )
  table.insert(
    ctrls,
    {
      Name = "L2TCRows",
      ControlType = "Knob",
      ControlUnit = "Integer",
      Style = "Text Field",
      PinStyle = "Output",
      Min = 0,
      Max = 9999999,
      Count = 1,
      UserPin = true
    }
  )
  table.insert(
    ctrls,
    {
      Name = "PlaylistPlayPrevious",
      ControlType = "Button",
      ButtonType = "Trigger",
      PinStyle = "Input",
      Count = 1,
      UserPin = true
    }
  )
  table.insert(
    ctrls,
    {
      Name = "PlaylistPlayNext",
      ControlType = "Button",
      ButtonType = "Trigger",
      PinStyle = "Input",
      Count = 1,
      UserPin = true
    }
  )
  table.insert(
    ctrls,
    {
      Name = "PlaylistPlayFirst",
      ControlType = "Button",
      ButtonType = "Trigger",
      PinStyle = "Input",
      Count = 1,
      UserPin = true
    }
  )
  table.insert(
    ctrls,
    {
      Name = "PlaylistPlayLast",
      ControlType = "Button",
      ButtonType = "Trigger",
      PinStyle = "Input",
      Count = 1,
      UserPin = true
    }
  )
  table.insert(
    ctrls,
    {
      Name = "PlaylistPlayRow",
      ControlType = "Button",
      ButtonType = "Trigger",
      PinStyle = "Input",
      Count = 1,
      UserPin = true
    }
  )
  table.insert(
    ctrls,
    {
      Name = "PlaylistPlayRowIndex",
      ControlType = "Knob",
      ControlUnit = "Integer",
      Style = "Text Field",
      PinStyle = "Both",
      Min = 1,
      Max = 9999999,
      DefaultValue = 1,
      Count = 1,
      UserPin = true
    }
  )
  table.insert(
    ctrls,
    {
      Name = "SystemRestart",
      ControlType = "Button",
      ButtonType = "Trigger",
      PinStyle = "Input",
      Count = 1,
      UserPin = true
    }
  )
  table.insert(
    ctrls,
    {
      Name = "SystemShutdown",
      ControlType = "Button",
      ButtonType = "Trigger",
      PinStyle = "Input",
      Count = 1,
      UserPin = true
    }
  )
  
  table.insert(
    ctrls,
    {
      Name = "SystemWake",
      ControlType = "Button",
      ButtonType = "Trigger",
      PinStyle = "Input",
      Count = 1,
      UserPin = true
    }
  )
  
  -- Controls for pin only - not to be displayed
  
  table.insert(
    ctrls,
    {
      Name = "PreviewEnable",
      ControlType = "Button",
      ButtonType = "Toggle",
      PinStyle = "Both",
      Count = 1,
      DefaultValue = 1,
      UserPin = true
    }
  )
  
  table.insert(
    ctrls,
    {
      Name = "LogMessage",
      ControlType = "Text",
      PinStyle = "Output",
      Count = 1,
      UserPin = true
    }
  )
  
  
  table.insert(
    ctrls,
    {
      Name = "SettingsJSON",
      ControlType = "Indicator",
      IndicatorType = "Text",
      PinStyle = "Both",
      Count = 1,
      UserPin = true
    }
  )
  table.insert(
    ctrls,
    {
      Name = "MappingJSON",
      ControlType = "Indicator",
      IndicatorType = "Text",
      PinStyle = "Both",
      Count = 1,
      UserPin = true
    }
  )
  table.insert(
    ctrls,
    {
      Name = "PlaylistJSON",
      ControlType = "Indicator",
      IndicatorType = "Text",
      PinStyle = "Both",
      Count = 1,
      UserPin = true
    }
  )
  table.insert(
    ctrls,
    {
      Name = "TimecodeJSON",
      ControlType = "Indicator",
      IndicatorType = "Text",
      PinStyle = "Both",
      Count = 1,
      UserPin = true
    }
  )
  table.insert(
    ctrls,
    {
      Name = "TimelineJSON",
      ControlType = "Indicator",
      IndicatorType = "Text",
      PinStyle = "Both",
      Count = 1,
      UserPin = true
    }
  )
  table.insert(
    ctrls,
    {
      Name = "SchedulerJSON",
      ControlType = "Indicator",
      IndicatorType = "Text",
      PinStyle = "Both",
      Count = 1,
      UserPin = true
    }
  )
  return ctrls
end

--Layout of controls and graphics for the plugin UI to display
function GetControlLayout(props)
  local layout = {}
  local graphics = {}
  -- we need to re-create the page list as it is nullified when entering this call
  CreatePages()
  
  -- common variables used by each page layout
  local CurrentPage = PageNames[props["page_index"].Value]
  local media_item_count = props["Media List Count"].Value
  local column_size = 12
  local fx1_column_size = 6
  local fx2_column_size = 6
  local btn_size = {32, 24}
  local btn_gap = {4, 4}
  local status_header_size = {12.5 * btn_size[1], 120}
  local status_groupbox_size = {12.5 * btn_size[1], 11 * btn_size[2]}
  local player_groupbox_position = {0, 0}
  local player_groupbox_size = {
    (((math.floor((#parameter_list / column_size)) + 1) * 6) + 1) * btn_size[1],
    (column_size + 2) * btn_size[2]
  }
  local fx1_groupbox_size = {
    (((math.floor((#fx1_list / fx1_column_size))) * 6) + 1) * btn_size[1],
    (fx1_column_size + 2) * btn_size[2]
  }
  local fx2_groupbox_size = {
    (((math.floor((#fx2_list / fx2_column_size))) * 6) + 1) * btn_size[1],
    (fx2_column_size + 2) * btn_size[2]
  }
  local preview_size = {2.4 * btn_size[1], (1.35 * btn_size[1])}
  local preview_groupbox_size = {
    (layer_count * preview_size[1]) + (4 * layer_count) + 8 + (3 * btn_size[1]),
    (2 * preview_size[2]) + 8
  }
  local media_list_groupbox_size = {
    (layer_count * preview_size[1]) + (4 * layer_count) + 8 + (3 * btn_size[1]),
    ((media_item_count + 1) * preview_size[2]) + 8
  }
  local module_enable_groupbox_size = {(16 * btn_size[1]) + (4 * btn_gap[1]), (2 * btn_size[2]) + (2 * btn_gap[2])}
  local module_playlist_groupbox_size = {(16 * btn_size[1]) + (4 * btn_gap[1]), (6 * btn_size[2]) + (2 * btn_gap[2])}
  local module_system_groupbox_size = {(16 * btn_size[1]) + (4 * btn_gap[1]), (2 * btn_size[2]) + (2 * btn_gap[2])}
  
  if CurrentPage then
    if CurrentPage == "Status" then
        table.insert(
          graphics,
          {
            Type = "GroupBox",
            HTextAlign = "Left",
            CornerRadius = 8,
            Fill = Colors.hive_grey,
            StrokeWidth = 1,
            Position = {0, 0},
            Size = status_header_size
          }
        )
        table.insert(
          graphics,
          {
            Type = "GroupBox",
            Text = "Setup",
            HTextAlign = "Left",
            CornerRadius = 8,
            Fill = Colors.hive_grey,
            StrokeWidth = 1,
            Position = {0, 0 + status_header_size[2] + btn_gap[2]},
            Size = status_groupbox_size
          }
        )
        local logo = 'iVBORw0KGgoAAAANSUhEUgAAAs4AAAEsCAYAAADTiDU4AAAACXBIWXMAAC4jAAAuIwF4pT92AAAFyWlUWHRYTUw6Y29tLmFkb2JlLnhtcAAAAAAAPD94cGFja2V0IGJlZ2luPSLvu78iIGlkPSJXNU0wTXBDZWhpSHpyZVN6TlRjemtjOWQiPz4gPHg6eG1wbWV0YSB4bWxuczp4PSJhZG9iZTpuczptZXRhLyIgeDp4bXB0az0iQWRvYmUgWE1QIENvcmUgOS4xLWMwMDIgNzkuYTFjZDEyZiwgMjAyNC8xMS8xMS0xOTowODo0NiAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvIiB4bWxuczpkYz0iaHR0cDovL3B1cmwub3JnL2RjL2VsZW1lbnRzLzEuMS8iIHhtbG5zOnBob3Rvc2hvcD0iaHR0cDovL25zLmFkb2JlLmNvbS9waG90b3Nob3AvMS4wLyIgeG1sbnM6eG1wTU09Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9tbS8iIHhtbG5zOnN0RXZ0PSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvc1R5cGUvUmVzb3VyY2VFdmVudCMiIHhtcDpDcmVhdG9yVG9vbD0iQWRvYmUgUGhvdG9zaG9wIDI2LjQgKFdpbmRvd3MpIiB4bXA6Q3JlYXRlRGF0ZT0iMjAyNS0wNS0xNlQxNTo1NTozMyswMTowMCIgeG1wOk1vZGlmeURhdGU9IjIwMjUtMDktMDNUMjI6MDg6MjMrMDE6MDAiIHhtcDpNZXRhZGF0YURhdGU9IjIwMjUtMDktMDNUMjI6MDg6MjMrMDE6MDAiIGRjOmZvcm1hdD0iaW1hZ2UvcG5nIiBwaG90b3Nob3A6Q29sb3JNb2RlPSIzIiB4bXBNTTpJbnN0YW5jZUlEPSJ4bXAuaWlkOjgwODM0ZGJiLWQ2YjEtN2U0NS04M2JiLTE4OGVmOTcxNzAwMCIgeG1wTU06RG9jdW1lbnRJRD0i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'
        table.insert(
          graphics,
          {
            Type = "Image",
            Position = {80, 10},
            Size = {240, 100},
            Image = logo,
          }
        )
        table.insert(
          graphics,
          {
            Type = "Text",
            Text = "STATUS:",
            Font = "Roboto",
            FontSize = 12,
            FontStyle = "Regular",
            HTextAlign = "Right",
            Color = Colors.control_label,
            Position = {0, (0.5 * btn_size[2]) + (1 * btn_gap[2]) + status_header_size[2]},
            Size = {3 * btn_size[1], btn_size[2]}
          }
        )
        table.insert(
          graphics,
          {
            Type = "Text",
            Text = "IP ADDRESS:",
            Font = "Roboto",
            FontSize = 12,
            FontStyle = "Regular",
            HTextAlign = "Right",
            Color = Colors.control_label,
            Position = {0, (1.5 * btn_size[2]) + (2 * btn_gap[2]) + status_header_size[2]},
            Size = {3 * btn_size[1], btn_size[2]}
          }
        )
        table.insert(
          graphics,
          {
            Type = "Text",
            Text = "DEVICE NAME:",
            Font = "Roboto",
            FontSize = 12,
            FontStyle = "Regular",
            HTextAlign = "Right",
            Color = Colors.control_label,
            Position = {0, (2.5 * btn_size[2]) + (3 * btn_gap[2]) + status_header_size[2]},
            Size = {3 * btn_size[1], btn_size[2]}
          }
        )
        table.insert(
          graphics,
          {
            Type = "Text",
            Text = "VERSION:",
            Font = "Roboto",
            FontSize = 12,
            FontStyle = "Regular",
            HTextAlign = "Right",
            Color = Colors.control_label,
            Position = {0, (3.5 * btn_size[2]) + (4 * btn_gap[2]) + status_header_size[2]},
            Size = {3 * btn_size[1], btn_size[2]}
          }
        )
        table.insert(
          graphics,
          {
            Type = "Text",
            Text = "UNIVERSE:",
            Font = "Roboto",
            FontSize = 12,
            FontStyle = "Regular",
            HTextAlign = "Right",
            Color = Colors.control_label,
            Position = {0, (4.5 * btn_size[2]) + (5 * btn_gap[2]) + status_header_size[2]},
            Size = {3 * btn_size[1], btn_size[2]}
          }
        )
        table.insert(
          graphics,
          {
            Type = "Text",
            Text = "OUTPUT RES:",
            Font = "Roboto",
            FontSize = 12,
            FontStyle = "Regular",
            HTextAlign = "Right",
            Color = Colors.control_label,
            Position = {0, (5.5 * btn_size[2]) + (6 * btn_gap[2]) + status_header_size[2]},
            Size = {3 * btn_size[1], btn_size[2]}
          }
        )
        table.insert(
          graphics,
          {
            Type = "Text",
            Text = "OUTPUT Hz:",
            Font = "Roboto",
            FontSize = 12,
            FontStyle = "Regular",
            HTextAlign = "Right",
            Color = Colors.control_label,
            Position = {0, (6.5 * btn_size[2]) + (7 * btn_gap[2]) + status_header_size[2]},
            Size = {3 * btn_size[1], btn_size[2]}
          }
        )
        table.insert(
          graphics,
          {
            Type = "Text",
            Text = "ENGINE FPS:",
            Font = "Roboto",
            FontSize = 12,
            FontStyle = "Regular",
            HTextAlign = "Right",
            Color = Colors.control_label,
            Position = {0, (7.5 * btn_size[2]) + (8 * btn_gap[2]) + status_header_size[2]},
            Size = {3 * btn_size[1], btn_size[2]}
          }
        )
        table.insert(
          graphics,
          {
            Type = "Text",
            Text = "ACTIVITY:",
            Font = "Roboto",
            FontSize = 12,
            FontStyle = "Regular",
            HTextAlign = "Right",
            Color = Colors.control_label,
            Position = {0, (8.5 * btn_size[2]) + (9 * btn_gap[2]) + status_header_size[2]},
            Size = {3 * btn_size[1], btn_size[2]}
          }
        )
        table.insert(
          graphics,
          {
            Type = "Text",
            Text = "NETMASK:",
            Font = "Roboto",
            FontSize = 12,
            FontStyle = "Regular",
            HTextAlign = "Right",
            Color = Colors.control_label,
            Position = {6 * btn_size[1], (1.5 * btn_size[2]) + (2 * btn_gap[2]) + status_header_size[2]},
            Size = {3 * btn_size[1], btn_size[2]}
          }
        )
        table.insert(
          graphics,
          {
            Type = "Text",
            Text = "SERIAL NO:",
            Font = "Roboto",
            FontSize = 12,
            FontStyle = "Regular",
            HTextAlign = "Right",
            Color = Colors.control_label,
            Position = {6 * btn_size[1], (2.5 * btn_size[2]) + (3 * btn_gap[2]) + status_header_size[2]},
            Size = {3 * btn_size[1], btn_size[2]}
          }
        )
        table.insert(
          graphics,
          {
            Type = "Text",
            Text = "BEE TYPE:",
            Font = "Roboto",
            FontSize = 12,
            FontStyle = "Regular",
            HTextAlign = "Right",
            Color = Colors.control_label,
            Position = {6 * btn_size[1], (3.5 * btn_size[2]) + (4 * btn_gap[2]) + status_header_size[2]},
            Size = {3 * btn_size[1], btn_size[2]}
          }
        )
        table.insert(
          graphics,
          {
            Type = "Text",
            Text = "FILE COUNT:",
            Font = "Roboto",
            FontSize = 12,
            FontStyle = "Regular",
            HTextAlign = "Right",
            Color = Colors.control_label,
            Position = {6 * btn_size[1], (4.5 * btn_size[2]) + (5 * btn_gap[2]) + status_header_size[2]},
            Size = {3 * btn_size[1], btn_size[2]}
          }
        )
        table.insert(
          graphics,
          {
            Type = "Text",
            Text = "FREE SPACE:",
            Font = "Roboto",
            FontSize = 12,
            FontStyle = "Regular",
            HTextAlign = "Right",
            Color = Colors.control_label,
            Position = {6 * btn_size[1], (5.5 * btn_size[2]) + (6 * btn_gap[2]) + status_header_size[2]},
            Size = {3 * btn_size[1], btn_size[2]}
          }
        )
        table.insert(
          graphics,
          {
            Type = "Text",
            Text = "CPU POWER:",
            Font = "Roboto",
            FontSize = 12,
            FontStyle = "Regular",
            HTextAlign = "Right",
            Color = Colors.control_label,
            Position = {6 * btn_size[1], (6.5 * btn_size[2]) + (7 * btn_gap[2]) + status_header_size[2]},
            Size = {3 * btn_size[1], btn_size[2]}
          }
        )
        table.insert(
          graphics,
          {
            Type = "Text",
            Text = "SYNC STATUS:",
            Font = "Roboto",
            FontSize = 12,
            FontStyle = "Regular",
            HTextAlign = "Right",
            Color = Colors.control_label,
            Position = {6 * btn_size[1], (7.5 * btn_size[2]) + (8 * btn_gap[2]) + status_header_size[2]},
            Size = {3 * btn_size[1], btn_size[2]}
          }
        )
        
        layout["Status"] = {
          PrettyName = "System~Status",
          Style = "TextBox",
          Position = {3 * btn_size[1], (0.5 * btn_size[2]) + (1 * btn_gap[2]) + status_header_size[2]},
          Size = {9 * btn_size[1], btn_size[2]}
        }
        
        layout["IPAddress"] = {
          PrettyName = "System~IP Address",
          Style = "TextBox",
          Color = Colors.control_background,
          TextColor = Colors.control_text,
          StrokeColor = Colors.control_text,
          FontSize = 12,
          StrokeWidth = 1,
          Position = {3 * btn_size[1], (1.5 * btn_size[2]) + (2 * btn_gap[2]) + status_header_size[2]},
          Size = {3 * btn_size[1], btn_size[2]}
        }
        layout["DeviceName"] = {
          PrettyName = "System~Device Name",
          Style = "TextBox",
          Color = Colors.control_background,
          TextColor = Colors.control_text,
          StrokeColor = Colors.control_text,
          StrokeWidth = 1,
          Position = {3 * btn_size[1], (2.5 * btn_size[2]) + (3 * btn_gap[2]) + status_header_size[2]},
          Size = {3 * btn_size[1], btn_size[2]}
        }
        layout["Universe"] = {
          PrettyName = "System~Universe",
          Style = "TextBox",
          Color = Colors.control_background,
          TextColor = Colors.control_text,
          StrokeColor = Colors.control_text,
          FontSize = 12,
          StrokeWidth = 1,
          Position = {3 * btn_size[1], (4.5 * btn_size[2]) + (5 * btn_gap[2]) + status_header_size[2]},
          Size = {3 * btn_size[1], btn_size[2]}
        }
        layout["Version"] = {
          PrettyName = "System~Version",
          Style = "TextBox",
          Color = Colors.control_background,
          TextColor = Colors.control_text,
          StrokeColor = Colors.control_text,
          FontSize = 12,
          StrokeWidth = 1,
          Position = {3 * btn_size[1], (3.5 * btn_size[2]) + (4 * btn_gap[2]) + status_header_size[2]},
          Size = {3 * btn_size[1], btn_size[2]}
        }
        
        layout["OutputResolution"] = {
          PrettyName = "System~Output Resolution",
          Style = "TextBox",
          Color = Colors.control_background,
          TextColor = Colors.control_text,
          StrokeColor = Colors.control_text,
          FontSize = 12,
          StrokeWidth = 1,
          Position = {3 * btn_size[1], (5.5 * btn_size[2]) + (6 * btn_gap[2]) + status_header_size[2]},
          Size = {3 * btn_size[1], btn_size[2]}
        }
        layout["OutputFramerate"] = {
          PrettyName = "System~Output Framerate",
          Style = "TextBox",
          Color = Colors.control_background,
          TextColor = Colors.control_text,
          StrokeColor = Colors.control_text,
          FontSize = 12,
          StrokeWidth = 1,
          Position = {3 * btn_size[1], (6.5 * btn_size[2]) + (7 * btn_gap[2]) + status_header_size[2]},
          Size = {3 * btn_size[1], btn_size[2]}
        }
        layout["EngineFPS"] = {
          PrettyName = "System~Engine FPS",
          Style = "TextBox",
          Color = Colors.control_background,
          TextColor = Colors.control_text,
          StrokeColor = Colors.control_text,
          FontSize = 12,
          StrokeWidth = 1,
          Position = {3 * btn_size[1], (7.5 * btn_size[2]) + (8 * btn_gap[2]) + status_header_size[2]},
          Size = {3 * btn_size[1], btn_size[2]}
        }
        layout["Activity"] = {
          PrettyName = "System~Engine FPS",
          Style = "TextBox",
          Color = Colors.control_background,
          TextColor = Colors.hive_yellow,
          StrokeColor = Colors.control_text,
          FontSize = 8,
          StrokeWidth = 1,
          Position = {3 * btn_size[1], (8.5 * btn_size[2]) + (9 * btn_gap[2]) + status_header_size[2]},
          Size = {9 * btn_size[1], btn_size[2]}
        }
        layout["Netmask"] = {
          PrettyName = "System~NetMask",
          Style = "TextBox",
          Color = Colors.control_background,
          TextColor = Colors.control_text,
          StrokeColor = Colors.control_text,
          FontSize = 12,
          StrokeWidth = 1,
          Position = {9 * btn_size[1], (1.5 * btn_size[2]) + (2 * btn_gap[2]) + status_header_size[2]},
          Size = {3 * btn_size[1], btn_size[2]}
        }
        layout["SerialNumber"] = {
          PrettyName = "System~Serial Number",
          Style = "TextBox",
          Color = Colors.control_background,
          TextColor = Colors.control_text,
          StrokeColor = Colors.control_text,
          FontSize = 12,
          StrokeWidth = 1,
          Position = {9 * btn_size[1], (2.5 * btn_size[2]) + (3 * btn_gap[2]) + status_header_size[2]},
          Size = {3 * btn_size[1], btn_size[2]}
        }
        layout["BeeType"] = {
          PrettyName = "System~Bee Type",
          Style = "TextBox",
          Color = Colors.control_background,
          TextColor = Colors.control_text,
          StrokeColor = Colors.control_text,
          FontSize = 12,
          StrokeWidth = 1,
          Position = {9 * btn_size[1], (3.5 * btn_size[2]) + (4 * btn_gap[2]) + status_header_size[2]},
          Size = {3 * btn_size[1], btn_size[2]}
        }
        layout["FileCount"] = {
          PrettyName = "System~Media File Count",
          Style = "TextBox",
          Color = Colors.control_background,
          TextColor = Colors.control_text,
          StrokeColor = Colors.control_text,
          FontSize = 12,
          StrokeWidth = 1,
          Position = {9 * btn_size[1], (4.5 * btn_size[2]) + (5 * btn_gap[2]) + status_header_size[2]},
          Size = {3 * btn_size[1], btn_size[2]}
        }
        layout["FreeSpace"] = {
          PrettyName = "System~Free Storage Space",
          Style = "TextBox",
          Color = Colors.control_background,
          TextColor = Colors.control_text,
          StrokeColor = Colors.control_text,
          FontSize = 12,
          StrokeWidth = 1,
          Position = {9 * btn_size[1], (5.5 * btn_size[2]) + (6 * btn_gap[2]) + status_header_size[2]},
          Size = {3 * btn_size[1], btn_size[2]}
        }
        layout["CpuPower"] = {
          PrettyName = "System~CPU Power",
          Style = "TextBox",
          Color = Colors.control_background,
          TextColor = Colors.control_text,
          StrokeColor = Colors.control_text,
          FontSize = 12,
          StrokeWidth = 1,
          Position = {9 * btn_size[1], (6.5 * btn_size[2]) + (7 * btn_gap[2]) + status_header_size[2]},
          Size = {3 * btn_size[1], btn_size[2]}
        }
        layout["SyncStatus"] = {
          PrettyName = "System~Beesync Status",
          Style = "TextBox",
          Color = Colors.control_background,
          TextColor = Colors.control_text,
          StrokeColor = Colors.control_text,
          FontSize = 12,
          StrokeWidth = 1,
          Position = {9 * btn_size[1], (7.5 * btn_size[2]) + (8 * btn_gap[2]) + status_header_size[2]},
          Size = {3 * btn_size[1], btn_size[2]}
        }
    elseif CurrentPage:sub(1, 6) == "Layer " then
        local i = tonumber(CurrentPage:match("Layer (%d+)"))
        
        table.insert(
          graphics,
          {
            Type = "GroupBox",
            Text = "Parameters",
            HTextAlign = "Left",
            CornerRadius = 8,
            Fill = Colors.hive_grey,
            StrokeWidth = 1,
            Position = {
              player_groupbox_position[1],
              player_groupbox_position[2]
            },
            Size = player_groupbox_size
          }
        )
        table.insert(
          graphics,
          {
            Type = "GroupBox",
            Text = "FX 1",
            HTextAlign = "Left",
            CornerRadius = 8,
            Fill = Colors.hive_grey,
            StrokeWidth = 1,
            Position = {
              player_groupbox_position[1],
              player_groupbox_size[2] + 8
            },
            Size = fx1_groupbox_size
          }
        )
        table.insert(
          graphics,
          {
            Type = "GroupBox",
            Text = "FX 2",
            HTextAlign = "Left",
            CornerRadius = 8,
            Fill = Colors.hive_grey,
            StrokeWidth = 1,
            Position = {
              player_groupbox_position[1],
              player_groupbox_size[2] + 16 + fx1_groupbox_size[2]
            },
            Size = fx2_groupbox_size
          }
        )
        for k, v in pairs(parameter_list) do
          local column = math.floor((k - 1) / column_size) + 1
          local row = k - (column - 1) * column_size
          table.insert(
            graphics,
            {
              Type = "Text",
              Text = v .. ":",
              Font = "Roboto",
              FontSize = 12,
              FontStyle = "Regular",
              HTextAlign = "Right",
              Color = Colors.control_label,
              Position = {
                player_groupbox_position[1] + ((6 * btn_size[1]) * (column - 1)),
                player_groupbox_position[2] + (row * btn_size[2])
              },
              Size = {3 * btn_size[1], btn_size[2]}
            }
          )
          local controlCol = Colors.control_background
          if control_list[v].Style == "Text Field" and control_list[v].ControlUnit == "Percent" then
            controlCol = Colors.control_background_light
          end
          layout[control_list[v].Name .. i] = {
            PrettyName = "Layer " .. i .. "~" .. v,
            Style = control_list[v].Style,
            Color = controlCol,
            TextColor = Colors.control_text,
            StrokeColor = Colors.control_text,
            FontSize = (v == "File Select") and 8 or 12,
            StrokeWidth = 1,
            Position = {
              player_groupbox_position[1] + ((6 * btn_size[1]) * (column - 1)) + (3 * btn_size[1]),
              player_groupbox_position[2] + (row * btn_size[2])
            },
            Size = {3 * btn_size[1], btn_size[2]}
          }
        end
        -- add the controls that are only there for the pins
        for k, v in pairs(pinonly_list) do
          layout[control_list[v].Name .. i] = {
            PrettyName = "Layer " .. i .. "~" .. v,
            Style = control_list[v].Style,
            Color = Colors.control_background,
            TextColor = Colors.control_text,
            StrokeColor = Colors.control_text,
            FontSize = (v == "File Select") and 8 or 12,
            StrokeWidth = 1,
            Position = {
              0,0
            },
            Size = {5,5}
          }
        end
        for k, v in pairs(fx1_list) do
          local column = math.floor((k - 1) / fx1_column_size) + 1
          local row = k - (column - 1) * fx1_column_size
          table.insert(
            graphics,
            {
              Type = "Text",
              Text = v .. ":",
              Font = "Roboto",
              FontSize = 12,
              FontStyle = "Regular",
              HTextAlign = "Right",
              Color = Colors.control_label,
              Position = {
                player_groupbox_position[1] + ((6 * btn_size[1]) * (column - 1)),
                player_groupbox_size[2] + 8 + (row * btn_size[2])
              },
              Size = {3 * btn_size[1], btn_size[2]}
            }
          )
          local controlCol = Colors.control_background
          if control_list[v].Style == "Text Field" and control_list[v].ControlUnit == "Percent" then
            controlCol = Colors.control_background_light
          end
          layout[control_list[v].Name .. i] = {
            PrettyName = "Layer " .. i .. "~" .. v,
            Style = control_list[v].Style,
            Color = controlCol,
            TextColor = Colors.control_text,
            StrokeColor = Colors.control_text,
            FontSize = 12,
            StrokeWidth = 1,
            Position = {
              player_groupbox_position[1] + ((6 * btn_size[1]) * (column - 1)) + (3 * btn_size[1]),
              player_groupbox_size[2] + 8 + (row * btn_size[2])
            },
            Size = {3 * btn_size[1], btn_size[2]}
          }
        end
        for k, v in pairs(fx2_list) do
          local column = math.floor((k - 1) / fx2_column_size) + 1
          local row = k - (column - 1) * fx2_column_size
          table.insert(
            graphics,
            {
              Type = "Text",
              Text = v .. ":",
              Font = "Roboto",
              FontSize = 12,
              FontStyle = "Regular",
              HTextAlign = "Right",
              Color = Colors.control_label,
              Position = {
                player_groupbox_position[1] + ((6 * btn_size[1]) * (column - 1)),
                player_groupbox_size[2] + 16 + fx1_groupbox_size[2] + (row * btn_size[2])
              },
              Size = {3 * btn_size[1], btn_size[2]}
            }
          )
          local controlCol = Colors.control_background
          if control_list[v].Style == "Text Field" and control_list[v].ControlUnit == "Percent" then
            controlCol = Colors.control_background_light
          end
          layout[control_list[v].Name .. i] = {
            PrettyName = "Layer " .. i .. "~" .. v,
            Style = control_list[v].Style,
            Color = controlCol,
            TextColor = Colors.control_text,
            StrokeColor = Colors.control_text,
            FontSize = 12,
            StrokeWidth = 1,
            Position = {
              player_groupbox_position[1] + ((6 * btn_size[1]) * (column - 1)) + (3 * btn_size[1]),
              player_groupbox_size[2] + 16 + fx1_groupbox_size[2] + (row * btn_size[2])
            },
            Size = {3 * btn_size[1], btn_size[2]}
          }
        end
    elseif CurrentPage == "Media" then
        table.insert(
          graphics,
          {
            Type = "GroupBox",
            Text = "Media List",
            HTextAlign = "Left",
            CornerRadius = 8,
            Fill = Colors.hive_grey,
            StrokeWidth = 1,
            Position = {0, 0},
            Size = media_list_groupbox_size
          }
        )
        table.insert(
          graphics,
          {
            Type = "Text",
            Text = "File Name",
            Font = "Roboto",
            FontSize = 12,
            FontStyle = "Regular",
            HTextAlign = "Right",
            Color = Colors.control_label,
            Position = {0, (1 * btn_size[2])},
            Size = {2 * btn_size[1], btn_size[2]}
          }
        )
        
        for i = 1, layer_count do
          table.insert(
            graphics,
            {
              Type = "Text",
              Text = string.format("Layer %s\nClip Select", i),
              Font = "Roboto",
              FontSize = 12,
              FontStyle = "Regular",
              HTextAlign = "Centre",
              Color = Colors.control_label,
              Position = {((i - 1) * preview_size[1]) + (3 * btn_size[1]) + 8, 8},
              Size = preview_size
            }
          )
          for p = 1, media_item_count do
            layout[string.format("MediaName%sLayer%s", p, i)] = {
              PrettyName = string.format("Layer %s~Media List~%s~Name", i, p),
              Style = "TextBox",
              Color = Colors.control_background,
              TextColor = Colors.control_text,
              HTextAlign = "Right",
              VTextAlign = "Centre",
              FontSize = 8,
              WordWrap = true,
              StrokeWidth = 0,
              Position = {
                4,
                (2 * btn_size[2]) + ((p - 1) * preview_size[2])
              },
              Size = {3 * btn_size[1], preview_size[2]}
            }
        
            layout[string.format("MediaThumbnail%sLayer%s", p, i)] = {
              PrettyName = string.format("Layer %s~Media List~%s~Select", i, p),
              UnlinkOffColor = true,
              OffColor = Colors.transparent,
              Color = Colors.Red,
              StrokeColor = Colors.control_text,
              ButtonVisualStyle = "Flat",
              Position = {
                ((i - 1) * preview_size[1]) + (3 * btn_size[1]) + 8,
                (2 * btn_size[2]) + ((p - 1) * preview_size[2])
              },
              Size = preview_size
            }
          end
        end
    elseif CurrentPage == "Modules" then
        table.insert(
          graphics,
          {
            Type = "GroupBox",
            Text = "Enable Disable",
            HTextAlign = "Left",
            CornerRadius = 8,
            Fill = Colors.hive_grey,
            StrokeWidth = 1,
            Position = {0, 0},
            Size = module_enable_groupbox_size
          }
        )
        table.insert(
          graphics,
          {
            Type = "GroupBox",
            Text = "Playlist Functions",
            HTextAlign = "Left",
            CornerRadius = 8,
            Fill = Colors.hive_grey,
            StrokeWidth = 1,
            Position = {0, module_enable_groupbox_size[2] + 4},
            Size = module_playlist_groupbox_size
          }
        )
        
        table.insert(
          graphics,
          {
            Type = "GroupBox",
            Text = "System",
            HTextAlign = "Left",
            CornerRadius = 8,
            Fill = Colors.hive_grey,
            StrokeWidth = 1,
            Position = {0, module_enable_groupbox_size[2] + module_playlist_groupbox_size[2] + 8},
            Size = module_system_groupbox_size
          }
        )
        
        layout["PlaylistEnable"] = {
          PrettyName = "Modules~Playlist Enable",
          Style = "Button",
          ButtonStyle = "Toggle",
          ButtonVisualStyle = "Flat",
          Color = Colors.enable_green,
          OffColor = Colors.control_background_light,
          UnlinkOffColor = true,
          TextColor = Colors.White,
          StrokeColor = Colors.control_text,
          Legend = "Playlist",
          FontSize = 12,
          StrokeWidth = 1,
          Position = {(2 * btn_gap[1]), btn_size[2]},
          Size = {3 * btn_size[1], btn_size[2]}
        }
        
        layout["L1TimecodeEnable"] = {
          PrettyName = "Modules~Layer 1 TC Cuelist Enable",
          Style = "Button",
          ButtonStyle = "Toggle",
          ButtonVisualStyle = "Flat",
          Color = Colors.enable_green,
          OffColor = Colors.control_background_light,
          UnlinkOffColor = true,
          TextColor = Colors.White,
          StrokeColor = Colors.control_text,
          Legend = "L1 TC Cuelist",
          FontSize = 12,
          StrokeWidth = 1,
          Position = {(3 * btn_size[1]) + (4 * btn_gap[1]), btn_size[2]},
          Size = {3 * btn_size[1], btn_size[2]}
        }
        
        layout["L2TimecodeEnable"] = {
          PrettyName = "Modules~Layer 2 TC Cuelist Enable",
          Style = "Button",
          ButtonStyle = "Toggle",
          ButtonVisualStyle = "Flat",
          Color = Colors.enable_green,
          OffColor = Colors.control_background_light,
          UnlinkOffColor = true,
          TextColor = Colors.White,
          StrokeColor = Colors.control_text,
          Legend = "L2 TC Cuelist",
          FontSize = 12,
          StrokeWidth = 1,
          Position = {(6 * btn_size[1]) + (6 * btn_gap[1]), btn_size[2]},
          Size = {3 * btn_size[1], btn_size[2]}
        }
        layout["TimelineEnable"] = {
          PrettyName = "Modules~Timeline Enable",
          Style = "Button",
          ButtonStyle = "Toggle",
          ButtonVisualStyle = "Flat",
          Color = Colors.enable_green,
          OffColor = Colors.control_background_light,
          UnlinkOffColor = true,
          TextColor = Colors.White,
          StrokeColor = Colors.control_text,
          Legend = "Timeline",
          FontSize = 12,
          StrokeWidth = 1,
          Position = {(9 * btn_size[1]) + (8 * btn_gap[1]), btn_size[2]},
          Size = {3 * btn_size[1], btn_size[2]}
        }
        layout["ScheduleEnable"] = {
          PrettyName = "Modules~Schedule Enable",
          Style = "Button",
          ButtonStyle = "Toggle",
          ButtonVisualStyle = "Flat",
          Color = Colors.enable_green,
          OffColor = Colors.control_background_light,
          UnlinkOffColor = true,
          TextColor = Colors.White,
          StrokeColor = Colors.control_text,
          Legend = "Scheduler",
          FontSize = 12,
          StrokeWidth = 1,
          Position = {(12 * btn_size[1]) + (10 * btn_gap[1]), btn_size[2]},
          Size = {3 * btn_size[1], btn_size[2]}
        }
        
        
        table.insert(
          graphics,
          {
            Type = "Text",
            Text = "Playlist Rows:",
            Font = "Roboto",
            FontSize = 12,
            FontStyle = "Regular",
            HTextAlign = "Right",
            Color = Colors.control_label,
            Position = {
              (0 * btn_size[1]) + (1 * btn_gap[1]),
              (1 * btn_gap[2]) + module_enable_groupbox_size[2] + (1 * btn_size[2])
            },
            Size = {3 * btn_size[1], btn_size[2]}
          }
        )
        table.insert(
          graphics,
          {
            Type = "Text",
            Text = "Current Row:",
            Font = "Roboto",
            FontSize = 12,
            FontStyle = "Regular",
            HTextAlign = "Right",
            Color = Colors.control_label,
            Position = {
              (0 * btn_size[1]) + (1 * btn_gap[1]),
              (2 * btn_gap[2]) + module_enable_groupbox_size[2] + (2 * btn_size[2])
            },
            Size = {3 * btn_size[1], btn_size[2]}
          }
        )
        table.insert(
          graphics,
          {
            Type = "Text",
            Text = "L1 TC Rows:",
            Font = "Roboto",
            FontSize = 12,
            FontStyle = "Regular",
            HTextAlign = "Right",
            Color = Colors.control_label,
            Position = {
              (0 * btn_size[1]) + (1 * btn_gap[1]),
              (3 * btn_gap[2]) + module_enable_groupbox_size[2] + (3 * btn_size[2])
            },
            Size = {3 * btn_size[1], btn_size[2]}
          }
        )
        table.insert(
          graphics,
          {
            Type = "Text",
            Text = "L2 TC Rows:",
            Font = "Roboto",
            FontSize = 12,
            FontStyle = "Regular",
            HTextAlign = "Right",
            Color = Colors.control_label,
            Position = {
              (0 * btn_size[1]) + (1 * btn_gap[1]),
              (4 * btn_gap[2]) + module_enable_groupbox_size[2] + (4 * btn_size[2])
            },
            Size = {3 * btn_size[1], btn_size[2]}
          }
        )
        
        layout["PlaylistRows"] = {
          PrettyName = "Modules~Playlist Rows",
          Style = "TextBox",
          Color = Colors.control_background,
          TextColor = Colors.control_text,
          StrokeColor = Colors.control_text,
          FontSize = 12,
          StrokeWidth = 1,
          Position = {
            (3 * btn_size[1]) + (1 * btn_gap[1]),
            (1 * btn_gap[2]) + module_enable_groupbox_size[2] + (1 * btn_size[2])
          },
          Size = {3 * btn_size[1], btn_size[2]}
        }
        
        layout["PlaylistCurrentRow"] = {
          PrettyName = "Modules~Playlist Current Row",
          Style = "TextBox",
          Color = Colors.control_background,
          TextColor = Colors.control_text,
          StrokeColor = Colors.control_text,
          FontSize = 12,
          StrokeWidth = 1,
          Position = {
            (3 * btn_size[1]) + (1 * btn_gap[1]),
            (2 * btn_gap[2]) + module_enable_groupbox_size[2] + (2 * btn_size[2])
          },
          Size = {3 * btn_size[1], btn_size[2]}
        }
        
        layout["L1TCRows"] = {
          PrettyName = "Modules~Layer 1 Cue List Rows",
          Style = "TextBox",
          Color = Colors.control_background,
          TextColor = Colors.control_text,
          StrokeColor = Colors.control_text,
          FontSize = 12,
          StrokeWidth = 1,
          Position = {
            (3 * btn_size[1]) + (1 * btn_gap[1]),
            (3 * btn_gap[2]) + module_enable_groupbox_size[2] + (3 * btn_size[2])
          },
          Size = {3 * btn_size[1], btn_size[2]}
        }
        
        
        
        layout["L2TCRows"] = {
          PrettyName = "Modules~Layer 2 Cue List Rows",
          Style = "TextBox",
          Color = Colors.control_background,
          TextColor = Colors.control_text,
          StrokeColor = Colors.control_text,
          FontSize = 12,
          StrokeWidth = 1,
          Position = {
            (3 * btn_size[1]) + (1 * btn_gap[1]),
            (4 * btn_gap[2]) + module_enable_groupbox_size[2] + (4 * btn_size[2])
          },
          Size = {3 * btn_size[1], btn_size[2]}
        }
        
        
        layout["PlaylistPlayPrevious"] = {
          PrettyName = "Modules~Playlist Play Previous",
          ButtonStyle = "Toggle",
          ButtonVisualStyle = "Flat",
          Color = Colors.enable_green,
          OffColor = Colors.control_background_light,
          UnlinkOffColor = true,
          TextColor = Colors.White,
          StrokeColor = Colors.control_text,
          Legend = "<< Previous",
          FontSize = 12,
          StrokeWidth = 1,
          Position = {
            (9 * btn_size[1]) + (3 * btn_gap[1]),
            (1 * btn_gap[2]) + module_enable_groupbox_size[2] + (1 * btn_size[2])
          },
          Size = {3 * btn_size[1], btn_size[2]}
        }
        
        layout["PlaylistPlayNext"] = {
          PrettyName = "Modules~Playlist Play Next",
          ButtonStyle = "Toggle",
          ButtonVisualStyle = "Flat",
          Color = Colors.enable_green,
          OffColor = Colors.control_background_light,
          UnlinkOffColor = true,
          TextColor = Colors.White,
          StrokeColor = Colors.control_text,
          Legend = "Next >>",
          FontSize = 12,
          StrokeWidth = 1,
          Position = {
            (12 * btn_size[1]) + (4 * btn_gap[1]),
            (1 * btn_gap[2]) + module_enable_groupbox_size[2] + (1 * btn_size[2])
          },
          Size = {3 * btn_size[1], btn_size[2]}
        }
        
        layout["PlaylistPlayFirst"] = {
          PrettyName = "Modules~Playlist Play First",
          ButtonStyle = "Toggle",
          ButtonVisualStyle = "Flat",
          Color = Colors.enable_green,
          OffColor = Colors.control_background_light,
          UnlinkOffColor = true,
          TextColor = Colors.White,
          StrokeColor = Colors.control_text,
          Legend = "<<<< First",
          FontSize = 12,
          StrokeWidth = 1,
          Position = {
            (9 * btn_size[1]) + (3 * btn_gap[1]),
            (2 * btn_gap[2]) + module_enable_groupbox_size[2] + (2 * btn_size[2])
          },
          Size = {3 * btn_size[1], btn_size[2]}
        }
        
        layout["PlaylistPlayLast"] = {
          PrettyName = "Modules~Playlist Play Last",
          ButtonStyle = "Toggle",
          ButtonVisualStyle = "Flat",
          Color = Colors.enable_green,
          OffColor = Colors.control_background_light,
          UnlinkOffColor = true,
          TextColor = Colors.White,
          StrokeColor = Colors.control_text,
          Legend = "Last >>>>",
          FontSize = 12,
          StrokeWidth = 1,
          Position = {
            (12 * btn_size[1]) + (4 * btn_gap[1]),
            (2 * btn_gap[2]) + module_enable_groupbox_size[2] + (2 * btn_size[2])
          },
          Size = {3 * btn_size[1], btn_size[2]}
        }
        
        layout["PlaylistPlayRow"] = {
          PrettyName = "Modules~Playlist Play Row",
          ButtonStyle = "Toggle",
          ButtonVisualStyle = "Flat",
          Color = Colors.enable_green,
          OffColor = Colors.control_background_light,
          UnlinkOffColor = true,
          TextColor = Colors.White,
          StrokeColor = Colors.control_text,
          Legend = "Play Row",
          FontSize = 12,
          StrokeWidth = 1,
          Position = {
            (9 * btn_size[1]) + (3 * btn_gap[1]),
            (3 * btn_gap[2]) + module_enable_groupbox_size[2] + (3 * btn_size[2])
          },
          Size = {3 * btn_size[1], btn_size[2]}
        }
        
        layout["PlaylistPlayRowIndex"] = {
          PrettyName = "Modules~Playlist Play Row Index",
          Style = "TextBox",
          Color = Colors.control_background,
          TextColor = Colors.control_text,
          StrokeColor = Colors.control_text,
          FontSize = 12,
          StrokeWidth = 1,
          Position = {
            (12 * btn_size[1]) + (4 * btn_gap[1]),
            (3 * btn_gap[2]) + module_enable_groupbox_size[2] + (3 * btn_size[2])
          },
          Size = {3 * btn_size[1], btn_size[2]}
        }
        
        
        layout["SystemRestart"] = {
          PrettyName = "System~Reboot Device",
          Style = "Button",
          ButtonVisualStyle = "Flat",
          Color = Colors.enable_green,
          OffColor = Colors.control_background_light,
          UnlinkOffColor = true,
          TextColor = Colors.White,
          StrokeColor = Colors.control_text,
          Legend = "REBOOT DEVICE",
          FontSize = 12,
          StrokeWidth = 1,
          Position = {
            (2 * btn_size[1]) + (4 * btn_gap[1]),
            (6 * btn_gap[2]) + module_enable_groupbox_size[2] + module_playlist_groupbox_size[2] 
          },
          Size = {4 * btn_size[1], btn_size[2]}
        }
        layout["SystemShutdown"] = {
          PrettyName = "System~Shutdown Device",
          Style = "Button",
          ButtonVisualStyle = "Flat",
          Color = Colors.enable_green,
          OffColor = Colors.control_background_light,
          UnlinkOffColor = true,
          TextColor = Colors.White,
          StrokeColor = Colors.control_text,
          Legend = "SHUTDOWN DEVICE",
          FontSize = 12,
          StrokeWidth = 1,
          Position = {
            (6 * btn_size[1]) + (8 * btn_gap[1]),
            (6 * btn_gap[2]) + module_enable_groupbox_size[2] + module_playlist_groupbox_size[2] 
          },
          Size = {4 * btn_size[1], btn_size[2]}
        }
        
        layout["SystemWake"] = {
          PrettyName = "System~Wake Device",
          Style = "Button",
          ButtonVisualStyle = "Flat",
          Color = Colors.enable_green,
          OffColor = Colors.control_background_light,
          UnlinkOffColor = true,
          TextColor = Colors.White,
          StrokeColor = Colors.control_text,
          Legend = "WAKE DEVICE",
          FontSize = 12,
          StrokeWidth = 1,
          Position = {
            (10 * btn_size[1]) + (12 * btn_gap[1]),
            (6 * btn_gap[2]) + module_enable_groupbox_size[2] + module_playlist_groupbox_size[2] 
          },
          Size = {4 * btn_size[1], btn_size[2]}
        }
    elseif CurrentPage == "Preview" then
      table.insert(
        graphics,
        {
          Type = "GroupBox",
          Text = "",
          HTextAlign = "Left",
          CornerRadius = 8,
          Fill = Colors.hive_grey,
          StrokeWidth = 1,
          Position = {0, 0},
          Size = preview_groupbox_size
        }
      )
      
      table.insert(
        graphics,
        {
          Type = "Text",
          Text = "Output Preview",
          Font = "Roboto",
          FontSize = 12,
          FontStyle = "Regular",
          HTextAlign = "Centre",
          Color = Colors.control_label,
          Position = {8, 8},
          Size = preview_size
        }
      )
      
      layout["OutputPreview"] = {
        PrettyName = "System~Preview",
        Style="Button",
        UnlinkOffColor = true,
        OffColor = Colors.transparent,
        Color = Colors.Black,
        StrokeColor = Colors.control_text,
        ButtonVisualStyle = "Flat",
        Position = {
           8,(2 * btn_size[2])
        },
        Size = preview_size,
        CornerRadius = 0,
        Margin = 0,
        Padding = 0
      }
      
      for i = 1, layer_count do
        table.insert(
          graphics,
          {
            Type = "Text",
            Text = string.format("Layer %s\nPreview", i),
            Font = "Roboto",
            FontSize = 12,
            FontStyle = "Regular",
            HTextAlign = "Centre",
            Color = Colors.control_label,
            Position = {((i - 1) * preview_size[1]) + (3 * btn_size[1]) + 8, 8},
            Size = preview_size
          }
        )
      
        layout[string.format("Layer%sPreview", i)] = {
          PrettyName = string.format("Layer %s~Preview", i),
          UnlinkOffColor = true,
          OffColor = Colors.transparent,
          Color = Colors.Black,
          StrokeColor = Colors.control_text,
          ButtonVisualStyle = "Flat",
          Position = {
            ((i - 1) * preview_size[1]) + (3 * btn_size[1]) + 8,
            (2 * btn_size[2])
          },
          Size = preview_size,
          CornerRadius = 0,
          Margin = 0,
          Padding = 0
        }
      end
    end
  
    -- pin only controls - not displayed
    layout["preview_enable"] = {
      PrettyName = "System~Preview Enable",
      Style = "None",
      Color = Colors.control_background,
      TextColor = Colors.control_text,
      StrokeColor = Colors.control_text,
      FontSize = 8,
      StrokeWidth = 1,
      Position = {
        0,
        0
      },
      Size = {5, 5}
    }
  
    layout["LogMessage"] = {
      PrettyName = "System~Log Message",
      Style = "None",
      Position = {
        0,
        0
      },
      Size = {5, 5}
    }
  
    -- add the JSON Data pins only if they are enabled in properties
    if (props["Enable JSON Data Pins (WARNING)"].Value == "Enabled") then
      layout["settings_json"] = {
        PrettyName = "JSON Data~Settings",
        Style = "None",
        Color = Colors.control_background,
        TextColor = Colors.control_text,
        StrokeColor = Colors.control_text,
        FontSize = 8,
        StrokeWidth = 1,
        Position = {
          0,
          0
        },
        Size = {5, 5}
      }
      layout["mapping_json"] = {
        PrettyName = "JSON Data~Mapping",
        Style = "None",
        Color = Colors.control_background,
        TextColor = Colors.control_text,
        StrokeColor = Colors.control_text,
        FontSize = 8,
        StrokeWidth = 1,
        Position = {
          0,
          0
        },
        Size = {5, 5}
      }
      layout["playlist_json"] = {
        PrettyName = "JSON Data~Playlist",
        Style = "None",
        Color = Colors.control_background,
        TextColor = Colors.control_text,
        StrokeColor = Colors.control_text,
        FontSize = 8,
        StrokeWidth = 1,
        Position = {
          0,
          0
        },
        Size = {5, 5}
      }
      layout["timecode_json"] = {
        PrettyName = "JSON Data~Timecode",
        Style = "None",
        Color = Colors.control_background,
        TextColor = Colors.control_text,
        StrokeColor = Colors.control_text,
        FontSize = 8,
        StrokeWidth = 1,
        Position = {
          0,
          0
        },
        Size = {5, 5}
      }
      layout["timeline_json"] = {
        PrettyName = "JSON Data~Timeline",
        Style = "None",
        Color = Colors.control_background,
        TextColor = Colors.control_text,
        StrokeColor = Colors.control_text,
        FontSize = 8,
        StrokeWidth = 1,
        Position = {
          0,
          0
        },
        Size = {5, 5}
      }
      layout["scheduler_json"] = {
        PrettyName = "JSON Data~Scheduler",
        Style = "None",
        Color = Colors.control_background,
        TextColor = Colors.control_text,
        StrokeColor = Colors.control_text,
        FontSize = 8,
        StrokeWidth = 1,
        Position = {
          0,
          0
        },
        Size = {5, 5}
      }
    end
  end
  return layout, graphics
end

--Start event based logic
if Controls then
-- This script is automatically loaded by the main script to define and initialize runtime variables

---- These variables can be changed during runtime
local file_list = {}
local file_list_names = {}
local selected_file = {}
local file_metadata_list = {}
local play_mode = {}
local seek_timer_list = {}
local seek_last_value = {}
local playlist_row_count = 0
local playlist_active_row = 1
local deice_settings = nil
local engine_fps = 0
local device_info = nil

for i = 1, layer_count do
  play_mode[i] = "In Frame"
  selected_file[i] = 0
  saved_play_mode = {}
  seek_timer_list[i] = Timer.New()
end

local media_item_count = Properties["Media List Count"].Value

local folder_list = {
  ["MEDIA"] = 0
}

local folder_choices = {}
for k, v in pairs(folder_list) do
  table.insert(folder_choices, k)
end

local lut_list = {
  ["NONE"] = 0
}
local lut_choices = {}
for k, v in pairs(lut_list) do
  table.insert(lut_choices, k)
end

-- Key and Value arrays to be used with all ENUM based controls, separating the keys and values
-- is the easiest way to maintain order but still allow them to be edited if required

-- Play Mode
local play_mode_keys = {
  "In Frame",
  "Out Frame",
  "Loop Forward",
  "Loop Reverse",
  "Play Once Forward",
  "Play Once Reverse",
  "Stop",
  "Pause",
  "Bounce (Ping-Pong)",
  "Take Over Frame",
  "Loop Forward with pause on zero intensity",
  "Loop Reverse with pause on zero intensity",
  "Play Once Forward with pause on zero intensity",
  "Play Once Reverse with pause on zero intensity",
  "Bounce (Ping-Pong) with pause on zero intensity",
  "Synchronise to Time code",
  "Loop Forward with re-trigger on intensity",
  "Loop Reverse with re-trigger on intensity",
  "Play Once Forward with re-trigger on intensity",
  "Play Once Reverse with re-trigger on intensity",
  "Bounce with re-trigger on intensity"
}

local play_mode_values = {
  0,
  1,
  2,
  3,
  4,
  5,
  6,
  7,
  8,
  9,
  10,
  11,
  12,
  13,
  15,
  20,
  40,
  41,
  42,
  43,
  45
}

-- Transition Mode
local transition_mode_keys = {
  "Alpha",
  "Additive",
  "Multiply",
  "Difference",
  "Screen",
  "Preserve Luma",
  "Rectangle Wipe",
  "Triangle Wipe",
  "Minimum",
  "Maximum",
  "Subtract",
  "Darken",
  "Lighten",
  "Soft Lighten",
  "Dark Lighten",
  "Exclusion",
  "Random",
  "Ripple",
  "Threshold",
  "Sine",
  "Invert Mask",
  "Noise",
  "Swirl",
  "Gradient",
  "Pixel Sort",
  "Checkerboard",
  "Pulse",
  "Hue Shift",
  "Fractal",
  "Waveform",
  "RGB Split",
  "Glitch"
}

local transition_mode_values = {
  0,
  1,
  2,
  3,
  4,
  5,
  6,
  7,
  8,
  9,
  10,
  11,
  12,
  13,
  14,
  15,
  16,
  17,
  18,
  19,
  20,
  21,
  22,
  23,
  24,
  25,
  26,
  27,
  28,
  29,
  30,
  31
}

-- Framing Mode
local framing_mode_keys = {
  "Letterbox",
  "Crop",
  "Stretch",
  "Multi Letterbox",
  "Centered"
}

local framing_mode_values = {
  0,
  1,
  2,
  3,
  4
}

-- Blend Mode
local blend_mode_keys = {
  "Alpha",
  "Additive",
  "Multiply",
  "Difference",
  "Screen",
  "Preserve Luma",
  "Rectangle Wipe",
  "Triangle Wipe"
}

local blend_mode_values = {
  0,
  1,
  2,
  3,
  4,
  5,
  6,
  7
}

-- FX
local fx_keys = {
  "NONE",
  "OLD TV",
  "SEPIA",
  "FEEDBACK",
  "BLUR",
  "CRYSTALISE",
  "FRACTAL SOUP",
  "RADAR",
  "PIXELISE",
  "SOFT EDGE OVAL",
  "TILE",
  "INFINITY ZOOM",
  "DOT GRID",
  "KALEIDOSCOPE",
  "MULTI MIRROR",
  "REBELLE DISTORT",
  "4 POINT WARP",
  "HALF TONE",
  "HALF TONE INV",
  "HALF TONE COL",
  "HALF TONE SMP",
  "SWIRL DISTORT",
  "GLITCH SPLIT",
  "BURN MELT NOISE",
  "SHATTER",
  "MULTI NOISE",
  "KALEIDO POP",
  "PRISM MIRAGE",
  "BLOCK PRISM",
  "SQUARE CLOUD",
  "CIRCLE PARTY",
  "EQ TUNNEL",
  "ELECTRO PATTERN",
  "4 POINT MASK",
  "8 POINT MASK",
  "Effect 35",
  "Effect 36",
  "Effect 37",
  "Effect 38",
  "Effect 39",
  "Effect 40"
}

local fx_values = {
  0,
  1,
  2,
  3,
  4,
  5,
  6,
  7,
  8,
  9,
  10,
  11,
  12,
  13,
  14,
  15,
  16,
  17,
  18,
  19,
  20,
  21,
  22,
  23,
  24,
  25,
  26,
  27,
  28,
  29,
  30,
  31,
  32,
  33,
  34,
  35,
  36,
  37,
  38,
  39,
  40
}

-- Q-SYS standard status states
local StatusState = {
  OK = 0,
  COMPROMISED = 1,
  FAULT = 2,
  NOTPRESENT = 3,
  MISSING = 4,
  INITIALIZING = 5
}

ticker = 1
poll_parameter_list = {}
for _, v in pairs(parameter_list) do
  if v ~= "Time Elapsed" and v ~= "Duration" and v ~= "Seek" then
    table.insert(poll_parameter_list, v:upper())
  end
end

local ip_address = Properties["IP Address"].Value

-- Utility functions to get key from value and vice versa in the ENUM tables
function get_table_key(tblKeys, tblValues, value)
  for i = 1, #tblValues do
    if tblValues[i] == value then
      return tblKeys[i]
    end
  end
  return nil
end

function get_table_value(tblKeys, tblValues, key)
  for i = 1, #tblKeys do
    if tblKeys[i] == key then
      return tblValues[i]
    end
  end
  return nil
end
-- Description: Utility functions for runtime scripts

-- Logging functions

-- Logs a message to both the Log and the console
function fn_log_message(message)
  Log.Message(message)
  print(message)
end
-- Logs an error message to both the Log and the console, but only if logging level is set to Errors Only or Debug
function fn_log_error(message)
  if Properties["Logging Level"].Value == "Errors Only" or Properties["Logging Level"].Value == "Debug" then
    Log.Error(message)
    print("Error: " .. message)
  end
end
-- Logs a debug message to both the Log and the console, but only if logging level is set to Debug
function fn_log_debug(message)
  if Properties["Logging Level"].Value == "Debug" then
    Log.Message("Debug: " .. message)
    print("Debug: " .. message)
  end
end

function setOnline()
  if Controls.Status.Value ~= StatusState.OK then
    Controls.Status.Value = StatusState.OK
  end
  if Controls.Status.String ~= "Online" then
    Controls.Status.String = "Online"
  end
end

function setInitializing(msg)
  if Controls.Status.Value ~= StatusState.INITIALIZING then
    Controls.Status.Value = StatusState.INITIALIZING
  end
  if Controls.Status.String ~= (msg or "Initializing") then
    Controls.Status.String = msg or "Initializing"
  end
end

function setFault(msg)
  if Controls.Status.Value ~= StatusState.FAULT then
    Controls.Status.Value = StatusState.FAULT
  end
  if Controls.Status.String ~= (msg or "Fault") then
    Controls.Status.String = msg or "Fault"
  end
end

function setCompromised(msg)
  if Controls.Status.Value ~= StatusState.COMPROMISED then
    Controls.Status.Value = StatusState.COMPROMISED
  end
  if Controls.Status.String ~= (msg or "Compromised") then
    Controls.Status.String = msg or "Compromised"
  end
end

function setMissing(msg)
  if Controls.Status.Value ~= StatusState.MISSING then
    Controls.Status.Value = StatusState.MISSING
  end
  if Controls.Status.String ~= (msg or "Missing") then
    Controls.Status.String = msg or "Missing"
  end
end

function setNotPresent(msg)
  if Controls.Status.Value ~= StatusState.NOTPRESENT then
    Controls.Status.Value = StatusState.NOTPRESENT
  end
  if Controls.Status.String ~= (msg or "Not Present") then
    Controls.Status.String = msg or "Not Present"
  end
end

---checks if a string represents an ip address
function fn_check_valid_ip(ip)
  if not ip then
    return false
  end
  local a, b, c, d = ip:match("^(%d%d?%d?)%.(%d%d?%d?)%.(%d%d?%d?)%.(%d%d?%d?)$")
  a = tonumber(a)
  b = tonumber(b)
  c = tonumber(c)
  d = tonumber(d)
  if not a or not b or not c or not d then
    return false
  end
  if a < 0 or 255 < a then
    return false
  end
  if b < 0 or 255 < b then
    return false
  end
  if c < 0 or 255 < c then
    return false
  end
  if d < 0 or 255 < d then
    return false
  end
  return true
end

-- compares two ip addresses, ignoring leading zeros
function fn_compare_ips(ip1, ip2)
  local function normalize(ip)
    local parts = {}
    if not ip then
      return ""
    end
    for octet in string.gmatch(ip, "%d+") do
      table.insert(parts, tostring(tonumber(octet))) -- remove leading zeros
    end
    return table.concat(parts, ".")
  end
  return normalize(ip1) == normalize(ip2)
end

--- Send Wake-on-LAN magic packet to a given MAC address.
-- @param mac           string  MAC like "AA:BB:CC:DD:EE:FF" or "AABBCCDDEEFF"
-- @return boolean|string       true on success, or nil + error message
function wake_on_lan(mac)
  local broadcast_ip = "255.255.255.255"
  local port = 9

  -- Strip separators like ":" or "-" etc.
  local hex = mac:gsub("[^0-9A-Fa-f]", "")
  if #hex ~= 12 then
    return nil, "Invalid MAC address format"
  end

  -- Convert MAC string to 6 raw bytes
  local mac_bytes = {}
  for i = 1, 12, 2 do
    local byte = tonumber(hex:sub(i, i + 1), 16)
    if not byte then
      return nil, "Invalid MAC address hex"
    end
    mac_bytes[#mac_bytes + 1] = string.char(byte)
  end
  local mac_raw = table.concat(mac_bytes)

  -- Build magic packet: 6 x 0xFF followed by MAC repeated 16 times
  local magic_packet = string.rep(string.char(0xFF), 6) .. string.rep(mac_raw, 16)

  local udp = UdpSocket.New()

  -- Send via UDP broadcast
  if not udp then
    return nil, "Failed to create UDP socket: " .. tostring(err)
  end
  udp:Open()
  udp:Send(broadcast_ip, port, magic_packet)

  -- close the port after 500ms
  Timer.CallAfter(
    function()
      udp:Close()
    end,
    0.5
  )

  return true
end
-- Description: Functions to interact with Hive via WebSocket

-- Load the RapidJSON library for JSON encoding/decoding
rapidjson = require("rapidjson")

-- Load the WebSocket library
ws = WebSocket.New()

-- Variables to manage WebSocket connection and callbacks
local wsConnected = false
local sequenceNo = 0
local pendingCallbacks = {}
local pendingRawCallbacks = {}
local refreshViewMap = {}
local handlers = {}
local connectionCallback = nil
local pingTimer = Timer.New()
local ipTarget = nil
local shouldConnect = false
local dataBuffer = "" -- Buffer to hold incoming data

-- Connect to the Hive WebSocket server
function Connect(ip, statusCallback)
  connectionCallback = statusCallback
  shouldConnect = true
  ipTarget = ip
  if (ipTarget) then
    fn_log_message("Connecting to Hive Device at " .. ipTarget)
    connectSocket(ipTarget)
  else
    fn_log_error("No IP address provided for Device connection.")
  end
end

-- Disconnect from the Hive WebSocket server
function Disconnect()
  shouldConnect = false
  ws:Close()
  wsConnected = false
  fn_log_message("Hive connection closed")
  if connectionCallback then
    connectionCallback(false, "Connection Closed") -- Call the status callback with false to indicate disconnection
  end
  pingTimer:Stop()
end

-- WebSocket event handlers
ws.Connected = function()
  wsConnected = true
  fn_log_message("Hive connection established")
  if connectionCallback then
    connectionCallback(true, "Online") -- Call the status callback with true to indicate success
  end
  -- send ping every 10 seconds to keep connection alive
  pingTimer:Start(10)
end

-- Handle WebSocket closure and attempt to reconnect if needed
ws.Closed = function()
  wsConnected = false
  fn_log_message("Hive connection closed")
  if connectionCallback then
    connectionCallback(false, "Connection Closed") -- Call the status callback with false to indicate disconnection
  end
  pingTimer:Stop()
  if shouldConnect then
    if ipTarget then
      fn_log_message("Attempting to reconnect to Hive Device at " .. ipTarget)
      if connectionCallback then
        connectionCallback(false, "Offline - Attempting to reconnect") -- Call the status callback with false to indicate disconnection
      end
      connectSocket(ipTarget) -- Attempt to reconnect
    else
      fn_log_error("No IP address provided for reconnection.")
    end
  end
end

-- Handle incoming data from the WebSocket
ws.Data = function(ws, data)
  -- Check if the data is a complete message or part of a larger message
  if (string.len(data) == 16384) then
    dataBuffer = dataBuffer .. data
  else
    -- data is complete, let's process it
    dataBuffer = dataBuffer .. data
    local response = rapidjson.decode(dataBuffer)
    local callback = nil
    -- check if we have a local handler that matches the response name
    if response and response.apiVersion == 1 and response.name and handlers[response.name] then
      -- check if we have a defined handler for this data
      callback = handlers[response.name]
      if callback then
        -- Call the handler with the response data
        callback(response.ret)
      end
    elseif response and response.apiVersion == 1 and response.sequence and pendingCallbacks[response.sequence] then
      callback = pendingCallbacks[response.sequence]
      if callback then
        -- Call the callback with the response data
        callback(response.args.Path, response.ret.Value)
        -- remove the callback from pendingCallbacks after it's called
        pendingCallbacks[response.sequence] = nil
      end
    elseif response and response.apiVersion == 1 and response.sequence and pendingRawCallbacks[response.sequence] then
      callback = pendingRawCallbacks[response.sequence]
      if callback then
        -- Call the callback with the response data
        callback(response.args.Path, dataBuffer)
        -- remove the callback from pendingCallbacks after it's called
        pendingRawCallbacks[response.sequence] = nil
      end
    else
      fn_log_error("No callback / handler found for data: ")
    end
    dataBuffer = "" -- Clear the buffer after processing
  end
end

-- Handle WebSocket errors
ws.Error = function(socket, err)
  fn_log_error("Hive connection error: " .. err)
  pingTimer:Stop()
  -- Attempt to reconnect if the connection is lost
  if wsConnected == false and shouldConnect == true then
    if ipTarget then
      fn_log_message("Attempting to reconnect to Hive Device at " .. ipTarget)
      if connectionCallback then
        connectionCallback(false, "Offline - Attempting to reconnect") -- Call the status callback with false to indicate disconnection
      end
      connectSocket(ipTarget) -- Attempt to reconnect
    end
  end
end

-- Timer to send ping messages to keep the WebSocket connection alive
pingTimer.EventHandler = function()
  fn_log_debug("Sending ping to Hive")
  ws:Ping()
end

-- Function to connect to the WebSocket server
function connectSocket(ip)
  -- Check if the WebSocket is already connected
  if (wsConnected) then
    fn_log_message("WebSocket is already connected.")
    ws:Close()
  end
  -- Connect to the Hive WebSocket server
  fn_log_debug("Connecting to Hive WebSocket at " .. ip)
  ws:Connect("ws", ip, "", 9002)
end

-- Handler for Watched Patch updates
function refreshView(refreshViewMessage)
  local callback = refreshViewMap[refreshViewMessage.Path]
  if callback then
    callback(refreshViewMessage.Path, refreshViewMessage.Value)
  else
    fn_log_error("No callback found for refresh view message: " .. refreshViewMessage)
  end
end

-- Register the refreshView handler
handlers["RefreshView"] = refreshView

-- Function to remove a watch on a specific path
function _RemoveWatch(path)
  if (wsConnected) then
    fn_log_debug("Removing watch for path: " .. path)
    -- Create the request object
    local request = {
      apiVersion = 1,
      name = "_RemoveWatch",
      args = {Path = path}
    }
    -- Send the request over the WebSocket
    ws:Write(rapidjson.encode(request), false)
  end
end

-- Public function to remove a watch and its associated callback
function removeWatch(path)
  if path then
    refreshViewMap[path] = nil
    _RemoveWatch(path)
    print("Removed watch for path: " .. path)
  end
end

-- Functions to get patch numerical values
function getPatchDouble(path, callback)
  if (wsConnected) then
    -- Increment the sequence number for each request
    sequenceNo = sequenceNo + 1
    if sequenceNo > 99999 then
      sequenceNo = 1 -- Reset sequence number if it exceeds 99999
    end
    -- Create the request object
    local request = {
      apiVersion = 1,
      name = "GetPatchDouble",
      args = {Path = path},
      sequence = sequenceNo
    }
    -- Store the callback for later use
    pendingCallbacks[sequenceNo] = callback
    -- Send the request over the WebSocket
    ws:Write(rapidjson.encode(request), false)
  end
end
-- Functions to set patch numerical values
function setPatchDouble(path, value)
  if (wsConnected) then
    -- Create the request object
    local request = {
      apiVersion = 1,
      name = "SetPatchDouble",
      args = {Path = path, Value = value}
    }
    -- Send the request over the WebSocket
    ws:Write(rapidjson.encode(request), false)
  end
end

-- Functions to watch for changes to patch numerical values
function _WatchPatchDouble(path)
  if (wsConnected) then
    -- Create the request object
    local request = {
      apiVersion = 1,
      name = "_WatchPatchDouble",
      args = {Path = path}
    }
    -- Send the request over the WebSocket
    ws:Write(rapidjson.encode(request), false)
  end
end

-- Public function to watch a patch numerical value and set up its callback
function watchPatchDouble(path, callback)
  refreshViewMap[path] = callback
  _WatchPatchDouble(path)
  getPatchDouble(path, callback)
end

-- Public function to get patch string values
function getPatchString(path, callback)
  if (wsConnected) then
    -- Increment the sequence number for each request
    sequenceNo = sequenceNo + 1
    if sequenceNo > 99999 then
      sequenceNo = 1 -- Reset sequence number if it exceeds 99999
    end
    -- Create the request object
    local request = {
      apiVersion = 1,
      name = "GetPatchString",
      args = {Path = path},
      sequence = sequenceNo
    }
    -- Store the callback for later use
    pendingCallbacks[sequenceNo] = callback
    -- Send the request over the WebSocket
    ws:Write(rapidjson.encode(request), false)
  end
end

-- Public function to set patch string values
function setPatchString(path, value)
  if (wsConnected) then
    -- Create the request object
    local request = {
      apiVersion = 1,
      name = "SetPatchString",
      args = {Path = path, Value = value}
    }
    -- Send the request over the WebSocket
    ws:Write(rapidjson.encode(request), false)
  end
end

-- Function to watch changes to patch string values
function _WatchPatchString(path)
  if (wsConnected) then
    -- Create the request object
    local request = {
      apiVersion = 1,
      name = "_WatchPatchString",
      args = {Path = path}
    }
    -- Send the request over the WebSocket
    ws:Write(rapidjson.encode(request), false)
  end
end

-- Public function to watch a patch string value and set up its callback
function watchPatchString(path, callback)
  refreshViewMap[path] = callback
  _WatchPatchString(path)
  getPatchString(path, callback)
end

-- Public function to get patch JSON values
function getPatchJSON(path, callback, raw)
  if (wsConnected) then
    -- Increment the sequence number for each request
    sequenceNo = sequenceNo + 1
    if sequenceNo > 99999 then
      sequenceNo = 1 -- Reset sequence number if it exceeds 99999
    end
    -- Create the request object
    local request = {
      apiVersion = 1,
      name = "GetPatchJSON",
      args = {Path = path},
      sequence = sequenceNo
    }
    -- Store the callback for later use
    if raw then
      pendingRawCallbacks[sequenceNo] = callback
    else
      pendingCallbacks[sequenceNo] = callback
    end
    -- Send the request over the WebSocket
    ws:Write(rapidjson.encode(request), false)
  end
end

-- Public function to set patch JSON values
function setPatchJSON(path, value)
  if (wsConnected) then
    -- Create the request object
    local request = {
      apiVersion = 1,
      name = "SetPatchJSON",
      args = {Path = path, Value = value}
    }
    -- Send the request over the WebSocket
    ws:Write(rapidjson.encode(request), false)
  end
end

-- Public function to update patch JSON values
function updatePatchJSON(path, value)
  if (wsConnected) then
    -- Create the request object
    local request = {
      apiVersion = 1,
      name = "UpdatePatchJSON",
      args = {Path = path, Value = value}
    }
    -- Send the request over the WebSocket
    ws:Write(rapidjson.encode(request), false)
  end
end

-- Function to watch changes to patch JSON values
function _WatchPatchJSON(path)
  if (wsConnected) then
    -- Create the request object
    local request = {
      apiVersion = 1,
      name = "_WatchPatchJSON",
      args = {Path = path}
    }
    -- Send the request over the WebSocket
    ws:Write(rapidjson.encode(request), false)
  end
end

-- Public function to watch a patch JSON value and set up its callback
function watchPatchJSON(path, callback)
  refreshViewMap[path] = callback
  _WatchPatchJSON(path)
  getPatchJSON(path, callback)
end
-- Logic to deal with connection and disconnection of the Hive player
function fn_hive_connect_Status(status, message)
  fn_log_debug("Setting connected status to " .. tostring(status))
  if status == true then
    setOnline()
    fn_watch_parameters()
    fn_update_info()
    fn_poll_info()
    fn_update_media_folders()
    fn_fetch_video_previews()
  else
    setMissing(message or "Offline")
    fn_blank_previews()
  end
end

-- Watch for parameter changes from the Hive player
function fn_watch_parameters()
  -- Watch for JSON updates
  fn_log_debug("Setting up JSON watchers")
  watchPatchJSON("/System Settings", fn_process_JSON_update)
  watchPatchJSON("/Media List", fn_process_JSON_update)
  watchPatchJSON("/Play List", fn_process_JSON_update)
  watchPatchJSON("/Timecode Cue List", fn_process_JSON_update)
  watchPatchJSON("/Schedule", fn_process_JSON_update)
  watchPatchJSON("/Timeline", fn_process_JSON_update)
  watchPatchJSON("/Output Mapping", fn_process_JSON_update)
  watchPatchDouble("/Playlist Control/Playlist Controller 1/Row Index", fn_process_playlist_row_update)
  -- get the LUT options and update controls
  -- set the RAW mode so we can parse the raw data manually
  getPatchJSON("/LUT Colour Modes", fn_process_LUT_data, true)
  fn_log_debug("LUT options requested")
  watchPatchString(
    "/Status/Text",
    function(path, value)
      Controls.Activity.String = value
    end
  )

  -- Watch for value changes in layer parameters
  fn_log_debug("Setting up layer parameter watchers")
  for i = 1, layer_count do
    for _, parameter in ipairs(poll_parameter_list) do
      local path = string.format("/LAYER %s/%s/Value", i, parameter)
      watchPatchDouble(path, fn_process_double_update)
    end
    for _, parameter in ipairs(fx1_list) do
      local path = string.format("/LAYER %s/%s/Value", i, parameter:upper())
      watchPatchDouble(path, fn_process_double_update)
    end
    for _, parameter in ipairs(fx2_list) do
      local path = string.format("/LAYER %s/%s/Value", i, parameter:upper())
      watchPatchDouble(path, fn_process_double_update)
    end
  end

  -- Watch for value changes in transport control parameters
  fn_log_debug("Setting up transport control watchers")
  for i = 1, layer_count do
    watchPatchDouble(string.format("/LAYER %s/Transport Control/Media Time/Value", i), fn_process_transport_update)
  end
end

-- Poll and update the engine FPS and BeeSync status every second
function fn_poll_info()
  if wsConnected == true then
    fn_log_debug("Polling engine FPS")
    getPatchString(
      "/Mapping/Render Resolution/FPS",
      function(path, value)
        fn_log_debug("Engine FPS: " .. value)
        engine_fps = tonumber(value) or 0
        Controls.EngineFPS.String = value
      end
    )
    fn_update_sync_status()
    fn_update_status()
  end
  if wsConnected then
    Timer.CallAfter(fn_poll_info, 1)
  end
end

function fn_update_status()
  if device_info and wsConnected then
    -- OK status ("" or "OK")
    if device_info.status == "OK" then
      -- warn if less than 50Gb free
      if device_info.space < (1024 * 1024 * 1024 * 50) then
        -- check is fps has dropped to below 80% of output rate
        setCompromised("Low Disk Space")
      elseif engine_fps < (device_info.rate * 0.8) then
        setCompromised("Low FPS")
      else
        setOnline()
      end
    else
      setFault(device_info.status)
    end
  end
end

-- Poll and update the BeeSync status
function fn_update_sync_status()
  if wsConnected ~= true then
    return
  end
  fn_log_debug("Polling BeeSync status")
  local url = string.format("http://%s/api/getBeeSyncStatus", ip_address)
  HttpClient.Post {
    Url = url,
    Data = rapidjson.encode({}), -- This can be anything
    Headers = {
      ["Content-Type"] = "application/json"
    },
    EventHandler = function(tbl, code, data, error, headers)
      if code == 200 then
        local info = rapidjson.decode(data)
        fn_log_debug("BeeSync status: " .. info.status)
        Controls.SyncStatus.String = info.status
      else
        fn_log_error("Failed to get BeeSync status: HTTP " .. tostring(code))
      end
    end
  }
end

-- Set the value of a layer parameter
function fn_send(layer, cmd, val)
  fn_log_debug(string.format("Sending command to layer %s: %s = %s", layer, cmd, tostring(val)))
  local path = "/LAYER " .. layer .. "/" .. cmd .. "/Value"
  setPatchDouble(path, val)
end

-- Set a JSON data value in full
function fn_send_json(cmd, val)
  fn_log_debug(string.format("Sending JSON command: %s = %s", cmd, rapidjson.encode(val)))
  local path = "/" .. cmd
  setPatchJSON(path, val)
end

-- Update a section of JSON data value
function fn_update_json(cmd, val)
  fn_log_debug(string.format("Updating JSON command: %s = %s", cmd, rapidjson.encode(val)))
  local path = "/" .. cmd
  updatePatchJSON(path, val)
end

-- Process the LUT data received from the Hive player
function fn_process_LUT_data(path, data)
  -- The LUT list is inside a JSON object under the "Value" key
  -- however it is not indexed so we have to extract the string pairs manually
  -- in order to maintain the ordering
  -- this is not ideal but it works
  fn_log_debug("Processing LUT data")
  -- find the start of the "Value" object
  local startPos = data:find('"Value"%s*:%s*{')
  if startPos then
    -- extract substring from "Value": { ... }
    local subStr = data:sub(startPos)
    -- stop at the matching closing brace for Value
    local braceCount, endPos = 0, nil
    for i = 1, #subStr do
      local c = subStr:sub(i, i)
      if c == "{" then
        braceCount = braceCount + 1
      elseif c == "}" then
        braceCount = braceCount - 1
        if braceCount == 0 then
          endPos = i
          break
        end
      end
    end
    if endPos then
      lut_list = {
        ["NONE"] = 0
      }
      lut_choices = {}
      local idx = 1
      table.insert(lut_choices, "NONE") -- Add "NONE" option
      local valueBlock = subStr:sub(1, endPos)
      -- now extract all keys inside "Value"
      for k in valueBlock:gmatch('"([^"]+)"%s*:') do
        if k ~= "Value" then
          table.insert(lut_choices, k)
          lut_list[k] = idx
          idx = idx + 1
        end
      end
      for i = 1, layer_count do
        Controls["lut_" .. i].Choices = lut_choices
      end
    end
  else
    fn_log_error("Failed to find LUT Value block in JSON data")
  end
end

-- Handle transport control updates from the Hive player
function fn_process_transport_update(path, value)
  local layer, parameter = path:match("/LAYER (%d+)/(%P+)")
  if parameter == "Transport Control" then
    local layer, parameter, sub_parameter = path:match("/LAYER (%d+)/(%P+)/(%P+)")
    local currentFileName = file_list_names[selected_file[tonumber(layer)]] or ""
    if sub_parameter == "Media Time" then
      if not seek_timer_list[tonumber(layer)]:IsRunning() then
        if
          currentFileName == "" or file_metadata_list[currentFileName] == nil or
            file_metadata_list[currentFileName].duration == 0
         then
          Controls["seek_" .. layer].Position = 0
          Controls["time_elapsed_" .. layer].String = os.date("!%X", 0)
        else
          local pos = tonumber(value) / file_metadata_list[currentFileName].duration
          Controls["seek_" .. layer].Position = pos
          Controls["time_elapsed_" .. layer].String = os.date("!%X", math.floor(value))
        end
      end
    end
  else
    fn_log_error("Unknown transport parameter: " .. parameter)
  end
end

-- Handle playlist row updates from the Hive player
function fn_process_playlist_row_update(path, value)
  fn_log_debug("Playlist active row updated to " .. tostring(value + 1))
  playlist_active_row = value + 1 -- convert from 0 based to 1 based
  Controls.PlaylistCurrentRow.Value = playlist_active_row
end

-- Handle double updates from the Hive player
function fn_process_double_update(path, value)
  fn_log_debug("Processing double update: " .. path .. " = " .. tostring(value))
  if path:sub(1, 6) == "/LAYER" then -- Layer parameter response
    local layer, parameter = path:match("/LAYER (%d+)/(%P+)/Value")
    if parameter then
      local control = string.format("%s_%s", parameter:gsub("%s", "_"):lower(), layer)
      if parameter == "FILE SELECT" then
        selected_file[tonumber(layer)] = value
        fn_update_selected_file_info(value, layer)
      elseif parameter == "FOLDER SELECT" then
        Controls[string.format("folder_select_index_%s", layer)].Value = value
        for k, v in pairs(folder_list) do
          if v == value then
            Controls[control].String = k
            break
          end
        end
      elseif parameter == "LUT" then
        Controls[string.format("lut_index_%s", layer)].Value = value
        for k, v in pairs(lut_list) do
          if v == value then
            Controls[control].String = k
            break
          end
        end
      elseif parameter:sub(-5, -1) == "FRAME" then
        Controls[control].Value = value
      elseif parameter == "PLAY MODE" then
        local key = get_table_key(play_mode_keys, play_mode_values, value)
        Controls[control].String = key
        Controls[string.format("play_mode_index_%s", layer)].Value = value
      elseif parameter == "FRAMING MODE" then
        local key = get_table_key(framing_mode_keys, framing_mode_values, value)
        Controls[control].String = key
        Controls[string.format("framing_mode_index_%s", layer)].Value = value
      elseif parameter == "BLEND MODE" then
        local key = get_table_key(blend_mode_keys, blend_mode_values, value)
        Controls[control].String = key
        Controls[string.format("blend_mode_index_%s", layer)].Value = value
      elseif parameter == "TRANSITION MODE" then
        local key = get_table_key(transition_mode_keys, transition_mode_values, value)
        Controls[control].String = key
        Controls[string.format("transition_mode_index_%s", layer)].Value = value
      elseif parameter == "FX1 SELECT" then
        local key = get_table_key(fx_keys, fx_values, value)
        Controls[control].String = key
        Controls[string.format("fx1_select_index_%s", layer)].Value = value
      elseif parameter == "FX2 SELECT" then
        local key = get_table_key(fx_keys, fx_values, value)
        Controls[control].String = key
        Controls[string.format("fx2_select_index_%s", layer)].Value = value
      elseif parameter == "PLAY SPEED" or parameter == "SCALE" then
        if value >= 0.5 then
          Controls[control].Position = (value - 0.4444444444444444) / 0.5555555555555556
        else
          Controls[control].Position = value / 5
        end
      elseif parameter:sub(1, 3) == "MTC" then
        Controls[control].Value = value
      elseif parameter:sub(1, 8) == "POSITION" then
        Controls[control].Value = (value * 200) - 100
      elseif parameter:sub(1, 8) == "ROTATION" then
        Controls[control].Value = (value * 2880) - 1440
      elseif parameter:sub(1, 19) == "TRANSITION DURATION" then
        Controls[control].Value = value
      elseif
        parameter == "RED" or parameter == "BLUE" or parameter == "GREEN" or parameter == "SATURATION" or
          parameter == "CONTRAST"
       then
        Controls[control].Value = (value * 200) - 100
      else -- parameters where data directly proportional to position
        Controls[control].Position = value
      end
    else
      fn_log_error("Unknown layer parameter: " .. path)
    end
  end
end

function fn_update_selected_file_info(value, layer)
  local found = false
  for media = 1, media_item_count do
    Controls[string.format("MediaThumbnail%sLayer%s", media, layer)].Boolean = media == (value + 1)
  end
  local currentFileName = file_list_names[tonumber(value)] or ""
  fn_update_preview_thumbnail(layer, currentFileName)
  Controls[string.format("file_select_%s", layer)].String = currentFileName
  Controls[string.format("file_select_index_%s", layer)].Value = tonumber(value)
  if file_metadata_list[currentFileName] then
    Controls["duration_" .. layer].String = os.date("!%X", math.floor(file_metadata_list[currentFileName].duration))
  else
    Controls["duration_" .. layer].String = os.date("!%X", 0)
  end
end

-- Clear the media list thumbnails and names
function fn_clear_media_thumbs()
  local iconStyleBlank = {
    DrawChrome = true,
    HorizontalAlignment = "Center",
    Legend = "",
    Padding = -12,
    Margin = 0,
    IconData = ""
  }
  local iconStyleBlankString = rapidjson.encode(iconStyleBlank)
  for i = 1, layer_count do
    for m = 1, media_item_count do
      Controls[string.format("MediaName%sLayer%s", m, i)].String = ""
      Controls[string.format("MediaThumbnail%sLayer%s", m, i)].Style = iconStyleBlankString
    end
  end
end

-- Handle JSON updates from the Hive player
function fn_process_JSON_update(path, value)
  fn_log_debug("Processing JSON update: " .. path)
  if path == "/System Settings" then
    device_settings = value
    if (Properties["Enable JSON Data Pins (WARNING)"].Value == "Enabled") then
      Controls.SettingsJSON.String = rapidjson.encode(value)
    end
    fn_update_info()
  elseif path == "/Media List" then
    local file_choice_list = {}
    file_list = {}
    file_list_names = {}
    file_metadata_list = {}
    fn_clear_media_thumbs()
    for _, file in ipairs(value.files) do
      file_list[file.name] = file.fileIndex - 1
      file_list_names[file.fileIndex - 1] = file.name
      table.insert(file_choice_list, file.name)
      file_metadata_list[file.name] = file
      for i = 1, layer_count do
        if Controls[string.format("MediaName%sLayer%s", file.fileIndex, i)] then
          Controls[string.format("MediaName%sLayer%s", file.fileIndex, i)].String = file.name
        end
      end
      fn_get_file_thumbnail(file.fileIndex, file.name)
    end
    for i = 1, layer_count do
      Controls["file_select_" .. i].Choices = file_choice_list
      fn_update_selected_file_info(selected_file[i], i)
    end
    -- let's update the system info as storage and num files might have changed
    fn_update_info()
  elseif path == "/Output Mapping" then
    if (Properties["Enable JSON Data Pins (WARNING)"].Value == "Enabled") then
      Controls.MappingJSON.String = rapidjson.encode(value)
    end
  elseif path == "/Play List" then
    fn_log_debug(
      "Playlist updated, total items: " ..
        tostring(value.list and #value.list or 0) .. ", enabled: " .. tostring(value.usePlayList)
    )
    if (Properties["Enable JSON Data Pins (WARNING)"].Value == "Enabled") then
      Controls.PlaylistJSON.String = rapidjson.encode(value)
    end
    if value.usePlayList and value.usePlayList == 1 then
      Controls.PlaylistEnable.Boolean = true
    else
      Controls.PlaylistEnable.Boolean = false
    end
    playlist_row_count = value.list and #value.list or 0
    Controls.PlaylistRows.Value = playlist_row_count
  elseif path == "/Timecode Cue List" then
    fn_log_debug(
      "Timecode Cue List updated, layer 1 items: " ..
        tostring(value.layers[1] and #(value.layers[1].list) or 0) ..
          ", layer 2 items: " ..
            tostring(value.layers[2] and #(value.layers[2].list) or 0) ..
              ", layer 1 enabled: " ..
                tostring(value.layers[1] and value.layers[1].useCueList == 1) ..
                  ", layer 2 enabled: " .. tostring(value.layers[2] and value.layers[2].useCueList == 1)
    )
    if (Properties["Enable JSON Data Pins (WARNING)"].Value == "Enabled") then
      Controls.TimecodeJSON.String = rapidjson.encode(value)
    end
    if value.layers[1] and value.layers[1].useCueList == 1 then
      Controls.L1TimecodeEnable.Boolean = true
    else
      Controls.L1TimecodeEnable.Boolean = false
    end
    if value.layers[2] and value.layers[2].useCueList == 1 then
      Controls.L2TimecodeEnable.Boolean = true
    else
      Controls.L2TimecodeEnable.Boolean = false
    end
    Controls.L1TCRows.Value = value.layers[1] and #(value.layers[1].list) or 0
    Controls.L2TCRows.Value = value.layers[2] and #(value.layers[2].list) or 0
  elseif path == "/Schedule" then
    fn_log_debug("Schedule updated, enabled: " .. tostring(value.useSchedule))
    if (Properties["Enable JSON Data Pins (WARNING)"].Value == "Enabled") then
      Controls.SchedulerJSON.String = rapidjson.encode(value)
    end
    if value.useSchedule and value.useSchedule == 1 then
      Controls.ScheduleEnable.Boolean = true
    else
      Controls.ScheduleEnable.Boolean = false
    end
  elseif path == "/Timeline" then
    fn_log_debug("Timeline updated, enabled: " .. tostring(value.useTimeline))
    if (Properties["Enable JSON Data Pins (WARNING)"].Value == "Enabled") then
      Controls.TimelineJSON.String = rapidjson.encode(value)
    end
    if value.useTimeline and value.useTimeline == 1 then
      Controls.TimelineEnable.Boolean = true
    else
      Controls.TimelineEnable.Boolean = false
    end
  elseif path == "/Vioso WB Settings" then
  elseif path == "/Screenberry WB Settings" then
  end
end

-- Request and update the device information from the Hive player
function fn_update_info()
  if wsConnected ~= true then
    return
  end
  fn_log_debug("Updating device info")
  local url = string.format("http://%s/api/getTileList", ip_address)
  HttpClient.Post {
    Url = url,
    Data = rapidjson.encode({}), -- This can be anything
    Headers = {
      ["Content-Type"] = "application/json"
    },
    EventHandler = function(tbl, code, data, error, headers)
      if code == 200 then
        local info = rapidjson.decode(data)
        fn_log_debug("Device info received")
        Controls.Version.String = info.hiveVersion

        if info and info.tileList then
          device_info = nil
          for _, tile in ipairs(info.tileList) do
            if fn_compare_ips(tile.ipAddress, ip_address) then
              device_info = tile
              break
            end
          end
          if device_info then
            Controls.DeviceName.String = device_info.deviceName
            Controls.IPAddress.String = device_info.ipAddress
            Controls.Netmask.String = device_info.netMask
            Controls.OutputFramerate.String = device_info.rate
            Controls.OutputResolution.String = string.format("%s x %s", device_info.resX, device_info.resY)
            Controls.SerialNumber.String = device_info.serial
            Controls.BeeType.String = (device_info.beeType == 1) and "Queen" or "Worker"
            Controls.FileCount.String = device_info.nFiles
            Controls.CpuPower.String = device_info.power
            Controls.Universe.String = device_settings.dmxUniverse
            Controls.FreeSpace.String = string.format("%.2f GB", tonumber(device_info.space) / (1024 * 1024 * 1024))
          end
        end
      else
        fn_log_error("Failed to get device info: HTTP " .. tostring(code))
      end
    end
  }
end

-- Request and update the thumbnail for a specific media index and filename
function fn_get_file_thumbnail(index, filename)
  if wsConnected ~= true then
    return
  end
  if index <= media_item_count then
    fn_log_debug("Requesting thumbnail for media index " .. tostring(index) .. ", file: " .. filename)
    HttpClient.Download {
      Url = string.format("http://%s/Thumbs/%s", ip_address, filename:gsub("%.%w+", ".jpg")),
      Headers = {},
      Auth = "basic",
      Timeout = 10,
      EventHandler = function(tbl, code, data, err, headers)
        if code == 200 then
          local iconStyle = {
            DrawChrome = true,
            HorizontalAlignment = "Center",
            Legend = "",
            Padding = -12,
            Margin = 0,
            IconData = Qlib.base64_enc(data)
          }
          for i = 1, layer_count do
            Controls[string.format("MediaThumbnail%sLayer%s", index, i)].Style = rapidjson.encode(iconStyle)
          end
        end
      end
    }
  else
    fn_log_error("Thumbnail index " .. tostring(index) .. " exceeds media item count of " .. tostring(media_item_count))
  end
end

-- Request and update the preview thumbnail for a specific layer and filename
function fn_update_preview_thumbnail(layer, filename)
  if wsConnected ~= true or tonumber(layer) > layer_count then
    return
  end
  fn_log_debug("Requesting preview for media  " .. filename)
  if file_list[filename] == nil then
    fn_log_error("Filename " .. filename .. " not found in file list")

    local iconStyleBlank = {
      DrawChrome = true,
      HorizontalAlignment = "Center",
      Legend = "",
      IconData = ""
    }
    local iconStyleBlankString = rapidjson.encode(iconStyleBlank)
    Controls[string.format("Layer%sPreview", layer)].Style = iconStyleBlankString
    if
      tonumber(layer) == 1 and
        (Properties["Output Video Preview"].Value == "Disabled" or not Controls.PreviewEnable.Boolean)
     then
      Controls.OutputPreview.Style = iconStyleBlankString
    end
  else
    HttpClient.Download {
      Url = string.format("http://%s/Thumbs/%s", ip_address, filename:gsub("%.%w+", ".jpg")),
      Headers = {},
      Auth = "basic",
      Timeout = 10,
      EventHandler = function(tbl, code, data, err, headers)
        if code == 200 then
          local iconStyle = {
            DrawChrome = false,
            Legend = "",
            IconData = Qlib.base64_enc(data)
          }
          Controls[string.format("Layer%sPreview", layer)].Style = rapidjson.encode(iconStyle)
          if
            tonumber(layer) == 1 and
              (Properties["Output Video Preview"].Value == "Disabled" or not Controls.PreviewEnable.Boolean)
           then
            Controls.OutputPreview.Style = rapidjson.encode(iconStyle)
          end
        end
      end
    }
  end
end

function fn_blank_previews()
  local iconStyleBlank = {
    DrawChrome = true,
    HorizontalAlignment = "Center",
    Legend = "",
    IconData = ""
  }
  local iconStyleBlankString = rapidjson.encode(iconStyleBlank)
  for i = 1, layer_count do
    Controls[string.format("Layer%sPreview", i)].Style = iconStyleBlankString
  end
  Controls.OutputPreview.Style = iconStyleBlankString
end

-- Periodically fetch and update the output video preview
function fn_fetch_video_previews()
  fn_update_output_video_preview()
  if wsConnected then
    local refresh_period = 1 / string.gsub(Properties["Preview Refresh"].Value, " fps", "")
    Timer.CallAfter(fn_fetch_video_previews, refresh_period)
  end
end

-- Request and update the output video preview
function fn_update_output_video_preview()
  if Properties["Output Video Preview"].Value == "Disabled" or not Controls.PreviewEnable.Boolean then
    return
  end
  fn_log_debug("Requesting output preview frame")
  local url = string.format("http://%s/api/getOutputFrame", ip_address)
  HttpClient.Post {
    Url = url,
    Data = rapidjson.encode(
      {
        includeImageData = true,
        dualFramesRequest = false
      }
    ), -- This can be anything
    Headers = {
      ["Content-Type"] = "application/json"
    },
    EventHandler = function(tbl, code, data, error, headers)
      if code == 200 then
        local frameData = rapidjson.decode(data)
        local iconStyle = {
          DrawChrome = false,
          Legend = "",
          IconData = frameData.imgDataMapped
        }
        if wsConnected then
          Controls.OutputPreview.Style = rapidjson.encode(iconStyle)
        end
      else
        fn_log_error("Failed to get output frame data ")
      end
    end
  }
end

-- retrieve the list of availiable media fiolders and update the options in he comboboxes
function fn_update_media_folders()
  if wsConnected ~= true then
    return
  end
  fn_log_debug("Updating media folder list")
  url = string.format("http://%s/api/getMediaFoldersList", ip_address)
  HttpClient.Post {
    Url = url,
    Data = rapidjson.encode({}), -- This can be anything
    Headers = {
      ["Content-Type"] = "application/json"
    },
    EventHandler = function(tbl, code, data, error, headers)
      if code == 200 then
        fn_log_debug("Media folder list received")
        local folders = rapidjson.decode(data)
        folder_list = {
          ["MEDIA"] = 0 -- Default folder
        }
        local index = 1
        for _, folder in pairs(folders.folders) do
          folder_list[folder] = index
          index = index + 1
        end
        folder_choices = {}
        for k, v in pairs(folder_list) do
          table.insert(folder_choices, k)
        end
        for i = 1, layer_count do
          Controls["folder_select_" .. i].Choices = folder_choices
        end
      else
        fn_log_error("Failed to get media folder list: HTTP " .. tostring(code))
      end
    end
  }
end

-- Set up seek timers and last value trackers
for layer, seek_timer in pairs(seek_timer_list) do
  seek_timer.EventHandler = function(timer)
    if Controls[string.format("seek_%s", layer)].String == seek_last_value[layer] then
      if Controls["file_select_" .. layer].String ~= "" then
        local frame =
          math.floor(
          file_metadata_list[Controls["file_select_" .. layer].String].duration *
            file_metadata_list[Controls["file_select_" .. layer].String].rate *
            Controls["seek_" .. layer].Position
        )
        -- Seek to desired frame
        local path = string.format("/LAYER %s/Transport Control/MediaClockGenerator/Seek", layer)
        setPatchDouble(path, frame)
      end
      seek_timer_list[layer]:Stop()
    end
    seek_last_value[layer] = Controls[string.format("seek_%s", layer)].String
  end
end

-- Initialize combobox choices
for i = 1, layer_count do
  Controls["play_mode_" .. i].Choices = play_mode_keys
  Controls["framing_mode_" .. i].Choices = framing_mode_keys
  Controls["blend_mode_" .. i].Choices = blend_mode_keys
  Controls["transition_mode_" .. i].Choices = transition_mode_keys
  Controls["fx1_select_" .. i].Choices = fx_keys
  Controls["fx2_select_" .. i].Choices = fx_keys
end

-- Connect
setInitializing("Connecting...")
if fn_check_valid_ip(ip_address) then
  fn_log_message("Connecting to Hive player at " .. ip_address)
  Connect(ip_address, fn_hive_connect_Status)
else
  setMissing("Invalid IP")
  fn_log_error("Invalid IP address: " .. ip_address)
end
-- Command functions called by control callbacks
function cmd_file_select(layer, x) -- 0..65535: File Select
  local currentFileName = file_list_names[selected_file[layer] + 1] or "None"
  if file_metadata_list[currentFileName] then
    Controls["duration_" .. layer].String = os.date("!%X", math.floor(file_metadata_list[currentFileName].duration))
  else
    Controls["duration_" .. layer].String = os.date("!%X", 0)
  end
  fn_send(layer, "FILE SELECT", x)
end

function cmd_folder_select(layer, x) -- 0..65535: Folder Select
  fn_send(layer, "FOLDER SELECT", x)
end

function cmd_intensity(layer, x)
  fn_send(layer, "INTENSITY", x)
end

function cmd_in_frame(layer, x)
  fn_send(layer, "IN FRAME", x)
end

function cmd_out_frame(layer, x)
  fn_send(layer, "OUT FRAME", x)
end

function cmd_play_mode(layer, x)
  fn_send(layer, "PLAY MODE", x)
end

function cmd_framing(layer, x)
  fn_send(layer, "FRAMING MODE", x)
end

function cmd_blend_mode(layer, x)
  fn_send(layer, "BLEND MODE", x)
end

function cmd_lut_select(layer, x)
  fn_send(layer, "LUT", x)
end

function cmd_play_speed(layer, x)
  fn_send(layer, "PLAY SPEED", x)
end

function cmd_movement_speed(layer, x)
  fn_send(layer, "MOVEMENT SPEED", x)
end

function cmd_tc_hour(layer, x)
  fn_send(layer, "MTC HOUR", x)
end

function cmd_tc_minute(layer, x)
  fn_send(layer, "MTC MINUTE", x)
end

function cmd_tc_second(layer, x)
  fn_send(layer, "MTC SECOND", x)
end

function cmd_tc_frame(layer, x)
  fn_send(layer, "MTC FRAME", x)
end

function cmd_scale(layer, x)
  fn_send(layer, "SCALE", x)
end

function cmd_aspect_ratio(layer, x)
  fn_send(layer, "ASPECT RATIO", x)
end

function cmd_position_x(layer, x)
  fn_send(layer, "POSITION X", x)
end

function cmd_position_y(layer, x)
  fn_send(layer, "POSITION Y", x)
end

function cmd_rotation_x(layer, x)
  fn_send(layer, "ROTATION X", x)
end

function cmd_rotation_y(layer, x)
  fn_send(layer, "ROTATION Y", x)
end

function cmd_rotation_z(layer, x)
  fn_send(layer, "ROTATION Z", x)
end

function cmd_red(layer, x)
  fn_send(layer, "RED", x)
end

function cmd_green(layer, x)
  fn_send(layer, "GREEN", x)
end

function cmd_blue(layer, x)
  fn_send(layer, "BLUE", x)
end

function cmd_hue(layer, x)
  fn_send(layer, "HUE", x)
end

function cmd_saturation(layer, x)
  fn_send(layer, "SATURATION", x)
end

function cmd_contrast(layer, x)
  fn_send(layer, "CONTRAST", x)
end

function cmd_strobe(layer, x)
  fn_send(layer, "STROBE", x)
end

function cmd_volume(layer, x)
  fn_send(layer, "VOLUME", x)
end

function cmd_transition_duration(layer, x)
  fn_send(layer, "TRANSITION DURATION", x)
end

function cmd_transition_mode(layer, x)
  fn_send(layer, "TRANSITION MODE", x)
end

function cmd_enable_playlist(x)
  fn_update_json("Play List", {{op = "replace", path = "/usePlayList", value = x}})
end

function cmd_enable_timeline(x)
  fn_update_json("Timeline", {{op = "replace", path = "/useTimeline", value = x}})
end

function cmd_enable_schedule(x)
  fn_update_json("Schedule", {{op = "replace", path = "/useSchedule", value = x}})
end

function cmd_enable_tc1(x)
  fn_update_json("Timecode Cue List", {{op = "replace", path = "/layers/0/useCueList", value = x}})
end

function cmd_enable_tc2(x)
  fn_update_json("Timecode Cue List", {{op = "replace", path = "/layers/1/useCueList", value = x}})
end

function cmd_update_settings_data(x)
      fn_log_debug("Updating System Settings JSON data")
  if check_hive_json_data_validity(x, "hive buzz settings list") == false then
    fn_log_error("Not sending invalid System Settings JSON data")
    return
  end
  fn_send_json("System Settings", rapidjson.decode(x))
end

function cmd_update_timeline_data(x)
    fn_log_debug("Updating Timeline JSON data")
  if check_hive_json_data_validity(x, "hive buzz timeline") == false then
    fn_log_error("Not sending invalid Timeline JSON data")
    return
  end
  fn_send_json("Timeline", rapidjson.decode(x))
end

function cmd_update_scheduler_data(x)
  fn_log_debug("Updating Scheduler JSON data")
  if check_hive_json_data_validity(x, "hive buzz schedule") == false then
    fn_log_error("Not sending invalid Scheduler JSON data")
    return
  end
  fn_send_json("Schedule", rapidjson.decode(x))
end

function cmd_update_timecode_data(x)
  fn_log_debug("Updating Timecode Cue List JSON data")
  if check_hive_json_data_validity(x, "hive buzz cue list") == false then
    fn_log_error("Not sending invalid Timecode Cue List JSON data")
    return
  end
  fn_send_json("Timecode Cue List", rapidjson.decode(x))
end

function cmd_update_playlist_data(x)
  fn_log_debug("Updating Output Playlist JSON data")
  if check_hive_json_data_validity(x, "hive buzz play list") == false then
    fn_log_error("Not sending invalid Playlist JSON data")
    return
  end
  fn_send_json("Play List", rapidjson.decode(x))
end

function cmd_update_mapping_data(x)
  fn_log_debug("Updating Output Mapping JSON data")
  if check_hive_json_data_validity(x, "hive buzz mapping region list") == false then
    fn_log_error("Not sending invalid Output Mapping JSON data")
    return
  end
  fn_send_json("Output Mapping", rapidjson.decode(x))
end

function check_hive_json_data_validity(json_string, description)
  -- check it can be encoded as JSON and matches expected description
  local status, result = pcall(rapidjson.decode, json_string)
  if status then
    if result and result.description == description then
      print("Valid " .. description .. " JSON data")
      return true
    else
      print("Invalid " .. description .. " JSON data")
      return false
    end
  else
    print("Invalid " .. description .. " JSON data")
    return false
  end
end

function cmd_playlist_play_previous()
  if playlist_row_count > 0 then
    local new_row = playlist_active_row - 1
    if new_row < 1 then
      new_row = playlist_row_count
    end
    setPatchDouble("/Playlist Control/Playlist Controller 1/Play List Next", new_row - 1)
  end
end

function cmd_playlist_play_next()
  if playlist_row_count > 0 then
    local new_row = playlist_active_row + 1
    if new_row > playlist_row_count then
      new_row = 1
    end
    setPatchDouble("/Playlist Control/Playlist Controller 1/Play List Next", new_row - 1)
  end
end

function cmd_playlist_play_first()
  if playlist_row_count > 0 then
    local new_row = 1
    setPatchDouble("/Playlist Control/Playlist Controller 1/Play List Next", new_row - 1)
  end
end

function cmd_playlist_play_last()
  if playlist_row_count > 0 then
    local new_row = playlist_row_count
    setPatchDouble("/Playlist Control/Playlist Controller 1/Play List Next", new_row - 1)
  end
end

function cmd_playlist_play_row(x)
  if playlist_row_count > 0 then
    local new_row = x
    if new_row < 1 then
      new_row = 1
    end
    if new_row > playlist_row_count then
      new_row = playlist_row_count
    end
    setPatchDouble("/Playlist Control/Playlist Controller 1/Play List Next", new_row - 1)
  end
end

function cmd_restart()
  if wsConnected ~= true then
    return
  end
  fn_log_message("Sending restart command to device")
  local url = string.format("http://%s/api/runSystemCommand", ip_address)
  HttpClient.Post {
    Url = url,
    Data = rapidjson.encode(
      {
        method = "Nectar_run_command",
        cmd = "sudo reboot"
      }
    ), -- This can be anything
    Headers = {
      ["Content-Type"] = "application/json"
    },
    EventHandler = function(tbl, code, data, error, headers)
      if code == 200 then
        fn_log_message("Restart command sent")
      else
        fn_log_error("Failed to send restart command: HTTP " .. tostring(code))
      end
    end
  }
end

function cmd_shutdown()
  if wsConnected ~= true then
    return
  end
  fn_log_message("Sending shutdown command to device")
  local url = string.format("http://%s/api/runSystemCommand", ip_address)
  HttpClient.Post {
    Url = url,
    Data = rapidjson.encode(
      {
        method = "Nectar_run_command",
        cmd = "sudo shutdown -h now"
      }
    ), -- This can be anything
    Headers = {
      ["Content-Type"] = "application/json"
    },
    EventHandler = function(tbl, code, data, error, headers)
      if code == 200 then
        fn_log_message("Shutdown command sent")
      else
        fn_log_error("Failed to send shutdown command: HTTP " .. tostring(code))
      end
    end
  }
end

function cmd_wake()
  fn_log_message("Sending wake command to device")
  local ok, err = wake_on_lan(Properties["MAC Address"].Value)
  if not ok then
    fn_log_error("Failed to send wake command: " .. tostring(err))
  else
    fn_log_message("Wake command sent")
  end
end

for i = 1, 2 do
  _G["cmd_fx" .. i .. "_select"] = function(layer, x)
    fn_send(layer, "FX" .. i .. " SELECT", x)
  end
  _G["cmd_fx" .. i .. "_opacity"] = function(layer, x)
    fn_send(layer, "FX" .. i .. " OPACITY", x)
  end
  for p = 1, 16 do
    _G["cmd_fx" .. i .. "_param_" .. p] = function(layer, x)
      fn_send(layer, "FX" .. i .. " PARAM " .. p, x)
    end
  end
end
-- Set up event handlers for controls
fn_log_debug("Setting up control event handlers")
for i = 1, layer_count do
  Controls["file_select_" .. i].EventHandler = function()
    cmd_file_select(i, file_list[Controls["file_select_" .. i].String])
  end
  Controls["folder_select_" .. i].EventHandler = function()
    cmd_folder_select(i, folder_list[Controls["folder_select_" .. i].String])
  end
  Controls["file_select_index_" .. i].EventHandler = function()
    cmd_file_select(i, Controls["file_select_index_" .. i].Value)
  end
  Controls["folder_select_index_" .. i].EventHandler = function()
    cmd_folder_select(i, Controls["folder_select_index_" .. i].Value)
  end
  Controls["intensity_" .. i].EventHandler = function()
    cmd_intensity(i, Controls["intensity_" .. i].Position)
  end
  Controls["in_frame_" .. i].EventHandler = function()
    cmd_in_frame(i, Controls["in_frame_" .. i].Value)
  end
  Controls["out_frame_" .. i].EventHandler = function()
    cmd_out_frame(i, Controls["out_frame_" .. i].Value)
  end
  Controls["play_mode_" .. i].EventHandler = function()
    local val = get_table_value(play_mode_keys, play_mode_values, Controls["play_mode_" .. i].String)
    cmd_play_mode(i, val)
  end
  Controls["play_mode_index_" .. i].EventHandler = function()
    cmd_play_mode(i, Controls["play_mode_index_" .. i].Value)
  end
  Controls["framing_mode_" .. i].EventHandler = function()
    local val = get_table_value(framing_mode_keys, framing_mode_values, Controls["framing_mode_" .. i].String)
    cmd_framing(i, val)
  end
  Controls["framing_mode_index_" .. i].EventHandler = function()
    cmd_framing(i, Controls["framing_mode_index_" .. i].Value)
  end
  Controls["blend_mode_" .. i].EventHandler = function()
    local val = get_table_value(blend_mode_keys, blend_mode_values, Controls["blend_mode_" .. i].String)
    cmd_blend_mode(i, val)
  end
  Controls["blend_mode_index_" .. i].EventHandler = function()
    cmd_blend_mode(i, Controls["blend_mode_index_" .. i].Value)
  end
  Controls["fx1_select_" .. i].EventHandler = function()
    local val = get_table_value(fx_keys, fx_values, Controls["fx1_select_" .. i].String)
    cmd_fx1_select(i, val)
  end
  Controls["fx1_select_index_" .. i].EventHandler = function()
    cmd_fx1_select(i, Controls["fx1_select_index_" .. i].Value)
  end
  Controls["fx2_select_" .. i].EventHandler = function()
    local val = get_table_value(fx_keys, fx_values, Controls["fx2_select_" .. i].String)
    cmd_fx2_select(i, val)
  end
  Controls["fx2_select_index_" .. i].EventHandler = function()
    cmd_fx2_select(i, Controls["fx2_select_index_" .. i].Value)
  end
  Controls["lut_" .. i].EventHandler = function()
    cmd_lut_select(i, lut_list[Controls["lut_" .. i].String])
  end
  Controls["lut_index_" .. i].EventHandler = function()
    cmd_lut_select(i, Controls["lut_index_" .. i].Value)
  end
  Controls["play_speed_" .. i].EventHandler = function()
    local converted_value = Controls["play_speed_" .. i].Position
    if Controls["play_speed_" .. i].Position >= 0.1 then
      converted_value = 0.5555555555555556 * Controls["play_speed_" .. i].Position + 0.4444444444444444
    else
      converted_value = 5 * Controls["play_speed_" .. i].Position
    end
    cmd_play_speed(i, converted_value)
  end
  Controls["move_speed_" .. i].EventHandler = function()
    cmd_movement_speed(i, Controls["movement_speed_" .. i].Position)
  end
  Controls["mtc_hour_" .. i].EventHandler = function()
    cmd_tc_hour(i, Controls["mtc_hour_" .. i].Value)
  end
  Controls["mtc_minute_" .. i].EventHandler = function()
    cmd_tc_minute(i, Controls["mtc_minute_" .. i].Value)
  end
  Controls["mtc_second_" .. i].EventHandler = function()
    cmd_tc_second(i, Controls["mtc_second_" .. i].Value)
  end
  Controls["mtc_frame_" .. i].EventHandler = function()
    cmd_tc_frame(i, Controls["mtc_frame_" .. i].Value)
  end
  Controls["scale_" .. i].EventHandler = function()
    local converted_value = Controls["scale_" .. i].Position
    if Controls["scale_" .. i].Position >= 0.1 then
      converted_value = 0.5555555555555556 * Controls["scale_" .. i].Position + 0.4444444444444444
    else
      converted_value = 5 * Controls["scale_" .. i].Position
    end
    cmd_scale(i, converted_value)
  end
  Controls["aspect_ratio_" .. i].EventHandler = function()
    cmd_aspect_ratio(i, Controls["aspect_ratio_" .. i].Position)
  end
  Controls["position_x_" .. i].EventHandler = function()
    cmd_position_x(i, (Controls["position_x_" .. i].Value + 100) / 200)
  end
  Controls["position_y_" .. i].EventHandler = function()
    cmd_position_y(i, (Controls["position_y_" .. i].Value + 100) / 200)
  end
  Controls["rotation_x_" .. i].EventHandler = function()
    cmd_rotation_x(i, (Controls["rotation_x_" .. i].Value + 1440) / 2880)
  end
  Controls["rotation_y_" .. i].EventHandler = function()
    cmd_rotation_y(i, (Controls["rotation_y_" .. i].Value + 1440) / 2880)
  end
  Controls["rotation_z_" .. i].EventHandler = function()
    cmd_rotation_z(i, (Controls["rotation_z_" .. i].Value + 1440) / 2880)
  end
  Controls["red_" .. i].EventHandler = function()
    cmd_red(i, (Controls["red_" .. i].Value + 100) / 200)
  end
  Controls["green_" .. i].EventHandler = function()
    cmd_green(i, (Controls["green_" .. i].Value + 100) / 200)
  end
  Controls["blue_" .. i].EventHandler = function()
    cmd_blue(i, (Controls["blue_" .. i].Value + 100) / 200)
  end
  Controls["hue_" .. i].EventHandler = function()
    cmd_hue(i, Controls["hue_" .. i].Position)
  end
  Controls["saturation_" .. i].EventHandler = function()
    cmd_saturation(i, (Controls["saturation_" .. i].Value + 100) / 200)
  end
  Controls["contrast_" .. i].EventHandler = function()
    cmd_contrast(i, (Controls["contrast_" .. i].Value + 100) / 200)
  end
  Controls["strobe_" .. i].EventHandler = function()
    cmd_strobe(i, Controls["strobe_" .. i].Position)
  end
  Controls["volume_" .. i].EventHandler = function()
    cmd_volume(i, Controls["volume_" .. i].Position)
  end
  Controls["seek_" .. i].EventHandler = function()
    seek_timer_list[i]:Start(.2)
  end
  Controls["transition_duration_" .. i].EventHandler = function()
    cmd_transition_duration(i, Controls["transition_duration_" .. i].Value)
  end
  Controls["transition_mode_" .. i].EventHandler = function()
    local val = get_table_value(transition_mode_keys, transition_mode_values, Controls["transition_mode_" .. i].String)
    cmd_transition_mode(i, val)
  end
  Controls["transition_mode_index_" .. i].EventHandler = function()
    cmd_transition_mode(i, Controls["transition_mode_index_" .. i].Value)
  end
  Controls["fx1_opacity_" .. i].EventHandler = function()
    _G["cmd_fx1_opacity"](i, Controls["fx1_opacity_" .. i].Position)
  end
  Controls["fx2_opacity_" .. i].EventHandler = function()
    _G["cmd_fx2_opacity"](i, Controls["fx2_opacity_" .. i].Position)
  end
  for p = 1, 16 do
    Controls[string.format("fx1_param_%s_%s", p, i)].EventHandler = function()
      _G["cmd_fx1_param_" .. p](i, Controls[string.format("fx1_param_%s_%s", p, i)].Position)
    end
    Controls[string.format("fx2_param_%s_%s", p, i)].EventHandler = function()
      _G["cmd_fx2_param_" .. p](i, Controls[string.format("fx2_param_%s_%s", p, i)].Position)
    end
  end

  for p = 1, media_item_count do
    Controls[string.format("MediaThumbnail%sLayer%s", p, i)].EventHandler = function()
      if Controls[string.format("MediaName%sLayer%s", p, i)].String ~= nil then
        cmd_file_select(i, file_list[Controls[string.format("MediaName%sLayer%s", p, i)].String])
      end
    end
  end
end

Controls.PlaylistEnable.EventHandler = function()
  cmd_enable_playlist(Controls.PlaylistEnable.Boolean and 1 or 0)
end
Controls.TimelineEnable.EventHandler = function()
  cmd_enable_timeline(Controls.TimelineEnable.Boolean and 1 or 0)
end
Controls.ScheduleEnable.EventHandler = function()
  cmd_enable_schedule(Controls.ScheduleEnable.Boolean and 1 or 0)
end
Controls.L1TimecodeEnable.EventHandler = function()
  cmd_enable_tc1(Controls.L1TimecodeEnable.Boolean and 1 or 0)
end
Controls.L2TimecodeEnable.EventHandler = function()
  cmd_enable_tc2(Controls.L2TimecodeEnable.Boolean and 1 or 0)
end
Controls.PlaylistPlayPrevious.EventHandler = function()
  cmd_playlist_play_previous()
end
Controls.PlaylistPlayNext.EventHandler = function()
  cmd_playlist_play_next()
end
Controls.PlaylistPlayFirst.EventHandler = function()
  cmd_playlist_play_first()
end
Controls.PlaylistPlayLast.EventHandler = function()
  cmd_playlist_play_last()
end
Controls.PlaylistPlayRow.EventHandler = function()
  if Controls.PlaylistPlayRowIndex.String ~= "" then
    local row = tonumber(Controls.PlaylistPlayRowIndex.String)
    if row then
      cmd_playlist_play_row(row)
    end
  end
end
Controls.SystemShutdown.EventHandler = function()
  cmd_shutdown()
end
Controls.SystemRestart.EventHandler = function()
  cmd_restart()
end
Controls.SystemWake.EventHandler = function()
  cmd_wake()
end

Controls.SettingsJSON.EventHandler = function()
  if Properties["Enable JSON Data Pins (WARNING)"].Value ~= "Enabled" then
    fn_log_warning("Attempted to send Settings JSON data while JSON Data Pins are disabled in properties.")
    return
  end
  cmd_update_settings_data(Controls.SettingsJSON.String)
end

Controls.TimelineJSON.EventHandler = function()
    if Properties["Enable JSON Data Pins (WARNING)"].Value ~= "Enabled" then
    fn_log_warning("Attempted to send Settings JSON data while JSON Data Pins are disabled in properties.")
    return
  end
  cmd_update_timeline_data(Controls.TimelineJSON.String)
end

Controls.SchedulerJSON.EventHandler = function()
  if Properties["Enable JSON Data Pins (WARNING)"].Value ~= "Enabled" then
    fn_log_warning("Attempted to send Settings JSON data while JSON Data Pins are disabled in properties.")
    return
  end
  cmd_update_scheduler_data(Controls.SchedulerJSON.String)
end

Controls.TimecodeJSON.EventHandler = function()
  if Properties["Enable JSON Data Pins (WARNING)"].Value ~= "Enabled" then
    fn_log_warning("Attempted to send Settings JSON data while JSON Data Pins are disabled in properties.")
    return
  end
  cmd_update_timecode_data(Controls.TimecodeJSON.String)
end

Controls.PlaylistJSON.EventHandler = function()
  if Properties["Enable JSON Data Pins (WARNING)"].Value ~= "Enabled" then
    fn_log_warning("Attempted to send Settings JSON data while JSON Data Pins are disabled in properties.")
    return
  end
  cmd_update_playlist_data(Controls.PlaylistJSON.String)
end
Controls.MappingJSON.EventHandler = function()
  if Properties["Enable JSON Data Pins (WARNING)"].Value ~= "Enabled" then
    fn_log_warning("Attempted to send Settings JSON data while JSON Data Pins are disabled in properties.")
    return
  end
  cmd_update_mapping_data(Controls.MappingJSON.String)
end

fn_log_debug("Control event handlers set up complete")
end
